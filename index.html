<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VendavalStore - Sistema de Gestão</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            /* Modern minimal palette - Purple, Blue, White, Light Gray, Soft Black */
            --primary: #7C3AED;
            --primary-light: #9F67FF;
            --accent: #3B82F6;
            --accent-light: #60A5FA;
            --white: #FFFFFF;
            --light-gray: #F3F4F6;
            --dark-gray: #6B7280;
            --soft-black: #0F172A;
            --card-bg: #1E293B;
            --border-color: rgba(124, 58, 237, 0.1);
            
            /* Shadows and effects */
            --shadow-glow: 0 0 30px rgba(124, 58, 237, 0.3);
            --shadow-card: 0 4px 20px rgba(0, 0, 0, 0.2);
            --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            transition: var(--transition-smooth);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(180deg, var(--soft-black) 0%, #1a2332 100%);
            color: var(--white);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .content-section {
            display: none;
            animation: fadeInUp 0.5s ease-out;
        }
        
        .content-section.active {
            display: block;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .form-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Modern Navigation Buttons */
        .nav-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 500;
            padding: 0.625rem 1.25rem;
            border-radius: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            transition: var(--transition-smooth);
            backdrop-filter: blur(10px);
        }
        
        .nav-button:hover {
            background: rgba(124, 58, 237, 0.15);
            border-color: var(--primary);
            color: var(--white);
            transform: translateY(-2px);
        }
        
        .nav-button.active {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-color: transparent;
            color: var(--white);
            box-shadow: var(--shadow-glow);
        }
        
        @media (max-width: 640px) {
            .nav-button {
                width: 100%;
                justify-content: flex-start;
            }
        }
        
        /* Modern Card Design */
        .card {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: var(--shadow-card);
        }
        
        /* Table Styling */
        .table-header {
            background: rgba(15, 23, 42, 0.5);
        }
        
        .table-row-hover:hover {
            background: rgba(124, 58, 237, 0.1);
            transform: scale(1.01);
        }
        
        /* Remove number input spin buttons */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none;
            margin: 0;
        }
        
        input[type=number] {
            -moz-appearance: textfield;
        }
        
        /* Modern Input Styling */
        input, select, textarea {
            background: rgba(15, 23, 42, 0.8) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            border-radius: 0.75rem !important;
            color: var(--white) !important;
            padding: 0.75rem !important;
            transition: var(--transition-smooth) !important;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none !important;
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1) !important;
        }
        
        /* Button Styling */
        button:not(.nav-button) {
            font-weight: 600;
            border-radius: 0.75rem;
            transition: var(--transition-smooth);
        }
        
        button:not(.nav-button):hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .bg-blue-600 {
            background: linear-gradient(135deg, var(--primary), var(--accent)) !important;
        }
        
        .bg-blue-600:hover {
            box-shadow: var(--shadow-glow) !important;
        }
        
        .bg-green-600 {
            background: linear-gradient(135deg, #10B981, #059669) !important;
        }
        
        .bg-red-500, .bg-red-600 {
            background: linear-gradient(135deg, #EF4444, #DC2626) !important;
        }
        
        /* Dashboard Stats Cards */
        .stats-card {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.25rem;
            transition: var(--transition-smooth);
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(124, 58, 237, 0.2);
            border-color: var(--primary);
        }
        
        /* Glow effects for icons */
        .icon-glow {
            filter: drop-shadow(0 0 10px currentColor);
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-light);
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="login-section" class="flex flex-col items-center justify-center min-h-screen p-4 relative">
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-primary/20 rounded-full blur-[100px] animate-pulse"></div>
            <div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-accent/20 rounded-full blur-[100px] animate-pulse" style="animation-delay: 1s;"></div>
        </div>
        
        <div class="relative card max-w-md w-full">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-primary to-accent flex items-center justify-center">
                 <img src="https://i.ibb.co/tMstwg7h/Whats-App-Image-2025-09-08-at-22-07-45.jpg" alt="Logo da VendavalStore" class="h-16 w-16 rounded-full">
                </div>
                <h2 class="text-4xl font-bold text-white mb-2">VendavalStore</h2>
                <p class="text-gray-400">Faça login para continuar</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                    <input type="email" id="email" required class="mt-1 block w-full">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-300 mb-2">Senha</label>
                    <input type="password" id="password" required class="mt-1 block w-full">
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="rememberEmail" class="w-4 h-4 text-blue-600 bg-slate-900 border-slate-700 rounded focus:ring-blue-500 focus:ring-2">
                    <label for="rememberEmail" class="ml-2 text-sm text-gray-300">Lembrar meu e-mail</label>
                </div>
                <div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-lg shadow-lg">
                        Entrar
                    </button>
                </div>
                <div class="text-center mt-4">
                    <button type="button" id="createAdminBtn" class="text-sm text-green-400-200 hover:text-primary transition-colors">
                      AJRSystem – Transformando processos em produtividade. 
                    </button>
                </div>
            </form>
        </div>
        
        <p class="absolute bottom-8 text-sm text-gray-500">
            
        </p>
    </div>

    <div id="main-content" class="container mx-auto p-4 sm:p-6 lg:p-8 hidden">
        <header class="card mb-8 flex flex-col lg:flex-row justify-between items-center gap-6">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-primary to-accent flex items-center justify-center">
                    <img src="https://i.ibb.co/tMstwg7h/Whats-App-Image-2025-09-08-at-22-07-45.jpg" alt="Logo da VendavalStore" class="h-14 w-13 rounded-full">
                </div>
                <h1 class="text-3xl font-bold text-white">VendavalStore</h1>
            </div>
            
            <nav class="flex flex-wrap gap-2 justify-center">
                <button onclick="showSection('dashboard')" class="nav-button active">
                    <i class="fas fa-home"></i> <span class="hidden sm:inline">Início</span>
                </button>
                <button onclick="showSection('clientes')" class="nav-button">
                    <i class="fas fa-users"></i> <span class="hidden sm:inline">Clientes</span>
                </button>
                <button onclick="showSection('produtos')" class="nav-button">
                    <i class="fas fa-box-open"></i> <span class="hidden sm:inline">Produtos</span>
                </button>
                <button onclick="showSection('eventos')" class="nav-button">
                    <i class="fas fa-calendar-alt"></i> <span class="hidden sm:inline">Eventos</span>
                </button>
                <button onclick="showSection('vendas')" class="nav-button">
                    <i class="fas fa-shopping-cart"></i> <span class="hidden sm:inline">Vendas</span>
                </button>
                <button onclick="showSection('relatorios')" class="nav-button">
                    <i class="fas fa-chart-bar"></i> <span class="hidden sm:inline">Relatórios</span>
                </button>
                <button onclick="openTextEditModal()" class="nav-button">
                    <i class="fas fa-pen"></i> <span class="hidden sm:inline">Editar</span>
                </button>
                <button onclick="showBackupModal()" class="nav-button">
                    <i class="fas fa-cloud-upload-alt"></i> <span class="hidden sm:inline">Backup</span>
                </button>
                <button onclick="logout()" class="nav-button" style="background: rgba(239, 68, 68, 0.2); border-color: #EF4444;">
                    <i class="fas fa-sign-out-alt"></i> <span class="hidden sm:inline">Sair</span>
                </button>
            </nav>
        </header>

        <div id="setup-instructions" class="bg-yellow-800 text-yellow-100 p-4 rounded-lg mb-6 hidden">
            <h3 class="font-bold text-lg mb-2">Atenção: Configuração Necessária!</h3>
            <p>Para que o VendavalStore salve seus dados, você precisa conectar seu próprio banco de dados Firebase.</p>
            <ol class="list-decimal list-inside mt-2">
                <li>Vá para o <a href="https://console.firebase.google.com/" target="_blank" class="font-semibold underline">console do Firebase</a> e crie um novo projeto.</li>
                <li>Adicione um novo aplicativo Web. Copie o código de configuração que o Firebase fornecerá.</li>
                <li>Abra este arquivo (`vendaval_store.html`) em um editor de texto e cole o código de configuração no lugar do placeholder <code>// PASTE YOUR FIREBASE CONFIG HERE</code> no script abaixo.</li>
                <li>Pronto! Recarregue a página e o sistema funcionará normalmente no seu computador.</li>
            </ol>
            <p class="mt-4">Assim que a configuração for concluída, esta mensagem desaparecerá e o programa será habilitado.</p>
        </div>

        <main id="dashboard" class="content-section active card">
            <h2 class="text-3xl font-bold text-white mb-8">Visão Geral</h2>
            <div id="dashboard-stats" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="stats-card p-6 rounded-xl flex items-center justify-between min-h-[160px]">
                    <div class="flex flex-col">
                        <h3 class="text-blue-300 text-sm font-medium mb-2">Total de Vendas</h3>
                        <p id="totalSalesCount" class="text-3xl font-bold text-white">0</p>
                    </div>
                    <i class="fas fa-shopping-cart text-5xl text-blue-500 icon-glow opacity-20"></i>
                </div>
                <div class="stats-card p-6 rounded-xl flex items-center justify-between min-h-[160px]">
                    <div class="flex flex-col">
                        <h3 class="text-green-300 text-sm font-medium mb-2">Faturamento Total</h3>
                        <p id="totalRevenue" class="text-3xl font-bold text-white">R$ 0,00</p>
                    </div>
                    <i class="fas fa-dollar-sign text-3xl text-green-500 icon-glow opacity-20"></i>
                </div>
                <div class="stats-card p-6 rounded-xl flex items-center justify-between min-h-[160px]">
                    <div class="flex flex-col">
                        <h3 class="text-purple-300 text-sm font-medium mb-2">Clientes</h3>
                        <p id="totalClientsCount" class="text-3xl font-bold text-white">0</p>
                    </div>
                    <i class="fas fa-users text-5xl text-purple-500 icon-glow opacity-20"></i>
                </div>
                <div class="stats-card p-6 rounded-xl flex items-center justify-between min-h-[160px]">
                    <div class="flex flex-col">
                        <h3 class="text-gray-300 text-sm font-medium mb-2">Produtos</h3>
                        <p id="totalProductsCount" class="text-3xl font-bold text-white">0</p>
                    </div>
                    <i class="fas fa-box-open text-5xl text-gray-400 icon-glow opacity-20"></i>
                </div>
            </div>
            
            <div id="dashboard-financial-stats" class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
                <div class="stats-card p-6 rounded-xl">
                    <h3 class="text-sm font-medium text-gray-300 mb-2">Valor Total de Produtos Vendidos</h3>
                    <p id="totalSalesValue" class="text-4xl font-bold text-green-400">R$ 0,00</p>
                </div>
                <div class="stats-card p-6 rounded-xl">
                    <h3 class="text-sm font-medium text-gray-300 mb-2">Total Recebido</h3>
                    <p id="totalReceivedValue" class="text-4xl font-bold text-blue-400">R$ 0,00</p>
                </div>
                <div class="stats-card p-6 rounded-xl">
                    <h3 class="text-sm font-medium text-gray-300 mb-2">Valor a Receber</h3>
                    <p id="totalPendingValue" class="text-4xl font-bold text-orange-400">R$ 0,00</p>
                </div>
            </div>
            
            <div class="mt-12">
                <h3 class="text-2xl font-bold text-white mb-6">Aniversariantes do Mês</h3>
                <div id="birthdaysList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    </div>
            </div>

            <div id="connection-status" class="mt-6 p-4 rounded-xl" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2);">
                <span id="status-message" class="text-blue-300 text-sm">Conectando ao banco de dados...</span>
            </div>
        </main>

        <div id="clientes" class="content-section card">
            <h2 class="text-2xl font-semibold text-white mb-4">Cadastro de Clientes</h2>
            <form id="clientForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="clientName" class="block text-sm font-medium text-slate-300">Nome:</label>
                    <input type="text" id="clientName" required class="mt-1 block w-full rounded-lg border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                </div>
                <div>
                    <label for="clientCpf" class="block text-sm font-medium text-slate-300">CPF:</label>
                    <input type="text" id="clientCpf" required class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                </div>
                <div>
                    <label for="clientPhone" class="block text-sm font-medium text-slate-300">Telefone:</label>
                    <input type="tel" id="clientPhone" class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                </div>
                <div>
                    <label for="clientEmergencyContactName" class="block text-sm font-medium text-slate-300">Nome do Contato de Emergência:</label>
                    <input type="text" id="clientEmergencyContactName" class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                </div>
                <div>
                    <label for="clientEmergencyContact" class="block text-sm font-medium text-slate-300">Telefone do Contato de Emergência:</label>
                    <input type="text" id="clientEmergencyContact" class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                </div>
                <div>
                    <label for="clientEmail" class="block text-sm font-medium text-slate-300">E-mail:</label>
                    <input type="email" id="clientEmail" class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                </div>
                <div class="sm:col-span-2">
                    <label for="clientBirthDate" class="block text-sm font-medium text-slate-300">Data de Nascimento:</label>
                    <input type="date" id="clientBirthDate" class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                </div>
                <div class="sm:col-span-2 flex justify-end">
                    <button type="submit" class="form-button bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105" disabled>
                        <i class="fas fa-save mr-2"></i> Salvar Cliente
                    </button>
                </div>
            </form>

            <h3 class="text-xl font-semibold text-white mb-2">Lista de Clientes</h3>
            <div class="mb-4">
                <input type="text" id="clientSearchInput" placeholder="Pesquisar clientes por nome ou CPF..." class="w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full bg-slate-800 rounded-lg">
                    <thead class="bg-slate-700">
                        <tr>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">Nome</th>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">CPF</th>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">Contato</th>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">Nome do Contato de Emergência</th>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">Telefone do Contato de Emergência</th>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="clientsTableBody" class="divide-y divide-slate-700">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="produtos" class="content-section card">
            <h2 class="text-2xl font-semibold text-white mb-4">Cadastro de Produtos</h2>
            <form id="productForm" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                <div>
                    <label for="productName" class="block text-sm font-medium text-slate-300">Nome do Produto:</label>
                    <input type="text" id="productName" required class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                </div>
                <div>
                    <label for="productCost" class="block text-sm font-medium text-slate-300">Valor de Custo (R$):</label>
                    <input type="number" id="productCost" step="0.01" value="0.00" required class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                </div>
                <div>
                    <label for="productStock" class="block text-sm font-medium text-slate-300">Estoque:</label>
                    <input type="number" id="productStock" value="0" required class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                </div>
                <div class="sm:col-span-3 flex justify-end">
                    <button type="submit" class="form-button bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105" disabled>
                        <i class="fas fa-save mr-2"></i> Salvar Produto
                    </button>
                </div>
            </form>
            
            <div class="flex items-center justify-between bg-slate-900 rounded-lg p-4 mb-6">
                <span class="text-xl font-bold text-white">Valor Total do Estoque:</span>
                <p class="text-2xl font-extrabold text-green-500">
                    <span id="totalStockValue">R$ 0,00</span>
                </p>
            </div>


            <h3 class="text-xl font-semibold text-white mb-2">Lista de Produtos</h3>
            <div class="mb-4">
                <input type="text" id="productSearchInput" placeholder="Pesquisar produtos por nome ou código..." class="w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full bg-slate-800 rounded-lg">
                    <thead class="bg-slate-700">
                        <tr>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">Código</th>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">Nome do Produto</th>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">Valor de Custo</th>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">Estoque</th>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody" class="divide-y divide-slate-700">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="eventos" class="content-section card">
            <h2 class="text-2xl font-semibold text-white mb-4">Cadastro de Eventos</h2>
            <form id="eventForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="eventName" class="block text-sm font-medium text-slate-300">Nome do Evento:</label>
                    <input type="text" id="eventName" required class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                </div>
                <div class="sm:col-span-2 flex justify-end">
                    <button type="submit" class="form-button bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105" disabled>
                        <i class="fas fa-save mr-2"></i> Salvar Evento
                    </button>
                </div>
            </form>
            <h3 class="text-xl font-semibold text-white mb-2">Lista de Eventos</h3>
            <div class="mb-4">
                <input type="text" id="eventSearchInput" placeholder="Pesquisar eventos por nome..." class="w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full bg-slate-800 rounded-lg">
                    <thead class="bg-slate-700">
                        <tr>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">Nome do Evento</th>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="eventsTableBody" class="divide-y divide-slate-700">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="vendas" class="content-section card">
            <h2 class="text-2xl font-semibold text-white mb-4">Cadastro e Gestão de Vendas</h2>
            
            <form id="saleForm" class="space-y-4 mb-6">
                <div>
                    <label for="saleClient" class="block text-sm font-medium text-slate-300">Cliente:</label>
                    <select id="saleClient" required class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2"></select>
                </div>
                <div>
                    <label for="saleEvent" class="block text-sm font-medium text-slate-300">Nome do Evento:</label>
                    <select id="saleEvent" required class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2"></select>
                </div>
                <div class="bg-slate-900 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-semibold text-white">Produtos da Venda</h3>
                        <button type="button" onclick="openProductSelectionModal('new-sale')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-plus-circle mr-2"></i> Adicionar Produtos
                        </button>
                    </div>
                    <div id="newSaleProductsList" class="space-y-2 text-slate-300">
                        </div>
                </div>

                <div class="bg-slate-900 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <span class="text-xl font-bold text-white">Valor Total:</span>
                        <span id="saleTotalValue" class="text-2xl font-extrabold text-green-500">R$ 0,00</span>
                    </div>
                </div>

                <div>
                    <label for="salePaymentMethod" class="block text-sm font-medium text-slate-300">Forma de Pagamento:</label>
                    <select id="salePaymentMethod" required class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                        <option value="pix-a-vista">Pix à vista</option>
                        <option value="pix-parcelado">Pix parcelado</option>
                    </select>
                </div>
                <div id="installmentsWrapper" class="hidden">
                    <label for="saleInstallments" class="block text-sm font-medium text-slate-300">Número de Parcelas (1x até 36x):</label>
                    <input type="number" id="saleInstallments" min="1" max="36" value="1" required class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                </div>
                
                <div class="flex justify-end mt-4">
                    <button type="submit" class="form-button bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105" disabled>
                        <i class="fas fa-money-check-alt mr-2"></i> Gerar Venda
                    </button>
                </div>
            </form>
            
            <h3 class="text-xl font-semibold text-white mb-2 mt-8">Histórico de Vendas</h3>
            <div class="mb-4">
                <input type="text" id="saleSearchInput" placeholder="Pesquisar vendas por ID..." class="w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full bg-slate-800 rounded-lg">
                    <thead class="bg-slate-700">
                        <tr>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">ID</th>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">Cliente</th>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">Produto(s)</th>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">Valor</th>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">Data</th>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">Status</th>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="salesTableBody" class="divide-y divide-slate-700">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div id="relatorios" class="content-section card">
            <h2 class="text-2xl font-semibold text-white mb-4">Relatórios de Vendas e Faturamento</h2>
            <div id="reports-content" class="text-slate-300">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="bg-slate-900 p-6 rounded-lg shadow-md p-4">
                        <p class="text-sm font-semibold text-slate-400">Faturamento Total</p>
                        <p id="reportsTotalRevenue" class="mt-1 text-2xl font-bold text-white">R$ 0,00</p>
                    </div>
                    <div class="bg-slate-900 p-6 rounded-lg shadow-md p-4">
                        <p class="text-sm font-semibold text-slate-400">Vendas Pagas</p>
                        <p id="paidSalesCount" class="mt-1 text-2xl font-bold text-green-500">0</p>
                    </div>
                    <div class="bg-slate-900 p-6 rounded-lg shadow-md p-4">
                        <p class="text-sm font-semibold text-slate-400">Vendas Em Andamento</p>
                        <p id="inProgressSalesCount" class="mt-1 text-2xl font-bold text-blue-500">0</p>
                    </div>
                    <div class="bg-slate-900 p-6 rounded-lg shadow-md p-4">
                        <p class="text-sm font-semibold text-slate-400">Vendas Vencidas</p>
                        <p id="overdueSalesCount" class="mt-1 text-2xl font-bold text-orange-500">0</p>
                    </div>
                     <div class="bg-slate-900 p-6 rounded-lg shadow-md p-4">
                        <p class="text-sm font-semibold text-slate-400">Vendas Faltando a Pagar</p>
                        <p id="pendingPaymentCount" class="mt-1 text-2xl font-bold text-orange-500">0</p>
                    </div>
                    <div class="bg-slate-900 p-6 rounded-lg shadow-md p-4">
                        <p class="text-sm font-semibold text-slate-400">Vendas Canceladas</p>
                        <p id="canceledSalesCount" class="mt-1 text-2xl font-bold text-red-500">0</p>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex flex-col sm:flex-row justify-center gap-4 flex-wrap">
                <button onclick="downloadDetailedReport('json')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-file-download mr-2"></i> Baixar Relatório Completo (JSON)
                </button>
                <button onclick="visualizarRelatorioPdf()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-file-pdf"></i> Visualizar Relatório Completo (PDF)
                </button>
                 <button onclick="visualizarRelatorioProdutosVendidos()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-box-check mr-2"></i> Produtos Vendidos (PDF)
                </button>
                <button onclick="showReportByEventModal()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-calendar-check mr-2"></i> Relatório por Eventos
                </button>
                <button onclick="visualizarRelatorioPedidosVencidos()" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-exclamation-triangle mr-2"></i> Pedidos Vencidos (PDF)
                </button>
            </div>
        </div>
        
        <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
            <div class="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
                <h3 class="text-lg font-semibold text-white mb-4">Confirmação</h3>
                <p id="modal-message" class="text-slate-300 mb-6"></p>
                <div class="flex justify-end gap-2">
                    <button id="modal-cancel-btn" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105">Cancelar</button>
                    <button id="modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105">Confirmar</button>
                </div>
            </div>
        </div>
        
        <div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
            <div class="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-lg">
                <h3 class="text-2xl font-semibold text-white mb-4 text-center">Gestão de Venda e Parcelas</h3>
                
                <div class="mb-4">
                    <p class="text-lg font-semibold text-white mb-2">Itens da Venda:</p>
                    <ul id="editSaleProductsList" class="space-y-2 max-h-48 overflow-y-auto">
                        </ul>
                    <div class="flex justify-end mt-2">
                        <button type="button" onclick="openProductSelectionModal('edit-sale')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-edit mr-2"></i> Adicionar/Alterar Produtos
                        </button>
                    </div>
                </div>

                <div class="mb-4">
                    <p class="text-lg font-semibold text-white mb-2">Informações da Venda:</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label for="editSaleEventSelect" class="block text-sm font-medium text-slate-300">Nome do Evento:</label>
                            <select id="editSaleEventSelect" required class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2"></select>
                        </div>
                        <div>
                            <label for="editSaleTotalValue" class="block text-sm font-medium text-slate-300">Valor Total da Venda (Nota R$):</label>
                            <!-- ALTERADO: REMOVIDO 'readonly' para permitir edição manual e correção -->
                            <input type="number" id="editSaleTotalValue" step="0.01" required class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                        </div>
                        <div>
                            <label for="editSalePaymentMethod" class="block text-sm font-medium text-slate-300">Forma de Pagamento:</label>
                            <select id="editSalePaymentMethod" required class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                                <option value="pix-a-vista">Pix à vista</option>
                                <option value="pix-parcelado">Pix parcelado</option>
                            </select>
                        </div>
                        
                        <div class="md:col-span-2 lg:col-span-1">
                            <label for="newInstallmentsInput" class="block text-sm font-medium text-slate-300">Novo Nº de Parcelas:</label>
                            <div class="flex items-center gap-2 mt-1">
                                <input type="number" id="newInstallmentsInput" min="1" max="36" class="flex-1 rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 text-sm border-2">
                                <button type="button" id="recalculateParcelsBtn" onclick="recalculateParcels()" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">Recalc</button>
                            </div>
                        </div>
                        <div>
                             <label for="advancePayment" class="block text-sm font-medium text-slate-300">Adiantamento (R$):</label>
                             <div class="flex items-center gap-2 mt-1">
                                 <input type="number" id="advancePayment" step="0.01" value="0.00" class="flex-1 rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 text-sm border-2">
                                 <button type="button" onclick="applyAdvancePayment()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">Aplicar</button>
                             </div>
                         </div>
                    </div>
                </div>

                <div class="mb-4">
                    <p class="text-lg font-semibold text-white mb-2">Gestão de Parcelas:</p>
                    <div id="parcelList" class="max-h-48 overflow-y-auto border-t border-b border-slate-700 py-4 text-slate-300">
                        </div>
                </div>

                <div class="mt-4">
                    <p class="text-lg font-semibold text-white mb-2">Histórico de Adiantamentos:</p>
                    <div id="advancementList" class="max-h-48 overflow-y-auto border-t border-slate-700 py-4 text-slate-300">
                        </div>
                </div>

                <div class="flex flex-wrap justify-end gap-2 mt-4">
                    <button id="saveChangesBtn" onclick="saveAllChanges()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-save mr-2"></i> Salvar Alterações
                    </button>
                    <button onclick="saveAndSendEmail()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-envelope mr-2"></i> Salvar e Enviar E-mail
                    </button>
                    <button onclick="saveAndVisualizarPdf()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-file-pdf mr-2"></i> Salvar e Visualizar PDF
                    </button>
                    <button onclick="hidePaymentModal()" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-times-circle mr-2"></i> Fechar
                    </button>
                </div>
            </div>
        </div>

        <div id="backupModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
            <div class="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
                <h3 class="text-lg font-semibold text-white mb-4 text-center">Gestão de Backup</h3>
                <p class="text-slate-300 text-center mb-6">Selecione uma opção para gerir os seus dados.</p>
                <div class="space-y-4">
                    <button onclick="downloadBackup()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-download mr-2"></i> Baixar Backup Atual
                    </button>
                    <label for="restore-file" class="w-full text-center bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105 cursor-pointer block">
                        <i class="fas fa-upload mr-2"></i> Carregar Dados do Backup
                    </label>
                    <input type="file" id="restore-file" accept="application/json" class="hidden">
                    <button onclick="hideBackupModal()" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-times-circle mr-2"></i> Cancelar
                    </button>
                </div>
            </div>
        </div>

        <div id="editProductModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
            <div class="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
                <h3 class="text-lg font-semibold text-white mb-4 text-center">Editar Produto</h3>
                <form id="editProductForm" class="space-y-4">
                    <div>
                        <label for="editProductName" class="block text-sm font-medium text-slate-300">Nome do Produto:</label>
                        <input type="text" id="editProductName" required class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                    </div>
                    <div>
                        <label for="editProductCost" class="block text-sm font-medium text-slate-300">Valor de Custo (R$):</label>
                        <input type="number" id="editProductCost" step="0.01" required class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                    </div>
                    <div>
                        <label for="editProductStock" class="block text-sm font-medium text-slate-300">Estoque:</label>
                        <input type="number" id="editProductStock" value="0" required class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                    </div>
                    <div class="flex justify-end gap-2 mt-4">
                        <button type="button" onclick="hideEditProductModal()" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105">Cancelar</button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="editClientModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
            <div class="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-lg">
                <h3 class="text-2xl font-semibold text-white mb-4 text-center">Editar Dados do Cliente</h3>
                <form id="editClientForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="editClientName" class="block text-sm font-medium text-slate-300">Nome:</label>
                        <input type="text" id="editClientName" required class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                    </div>
                    <div>
                        <label for="editClientCpf" class="block text-sm font-medium text-slate-300">CPF:</label>
                        <input type="text" id="editClientCpf" required class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                    </div>
                    <div>
                        <label for="editClientPhone" class="block text-sm font-medium text-slate-300">Telefone:</label>
                        <input type="tel" id="editClientPhone" class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                    </div>
                    <div>
                        <label for="editClientEmergencyContactName" class="block text-sm font-medium text-slate-300">Nome do Contato de Emergência:</label>
                        <input type="text" id="editClientEmergencyContactName" class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                    </div>
                    <div>
                        <label for="editClientEmergencyContact" class="block text-sm font-medium text-slate-300">Telefone do Contato de Emergência:</label>
                        <input type="text" id="editClientEmergencyContact" class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                    </div>
                    <div>
                        <label for="editClientEmail" class="block text-sm font-medium text-slate-300">E-mail:</label>
                        <input type="email" id="editClientEmail" class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                    </div>
                    <div class="sm:col-span-2">
                        <label for="editClientBirthDate" class="block text-sm font-medium text-slate-300">Data de Nascimento:</label>
                        <input type="date" id="editClientBirthDate" class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                    </div>
                    <div class="sm:col-span-2 flex justify-end gap-2 mt-4">
                        <button type="button" onclick="hideEditClientModal()" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105">Cancelar</button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105">Salvar Alterações</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- NOVO MODAL PARA EDIÇÃO DE ID DE VENDA -->
        <div id="editSaleIdModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
            <div class="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
                <h3 class="text-xl font-semibold text-white mb-4 text-center">Editar ID da Venda</h3>
                <form id="editSaleIdForm" class="space-y-4">
                    <input type="hidden" id="originalSaleId">
                    <div>
                        <label for="currentSaleIdDisplay" class="block text-sm font-medium text-slate-300">ID Atual:</label>
                        <input type="text" id="currentSaleIdDisplay" readonly class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-slate-400 shadow-sm p-2 border-2 cursor-not-allowed">
                    </div>
                    <div>
                        <label for="newSaleIdInput" class="block text-sm font-medium text-slate-300">Novo ID da Venda:</label>
                        <input type="text" id="newSaleIdInput" required class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="flex justify-end gap-2 mt-4">
                        <button type="button" onclick="hideEditSaleIdModal()" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105">Cancelar</button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105">Salvar Novo ID</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- FIM DO NOVO MODAL -->

        <div id="productSelectionModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
            <div class="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-2xl">
                <h3 class="text-2xl font-semibold text-white mb-4 text-center">Adicionar Produtos à Venda</h3>
                <div class="mb-4">
                    <input type="text" id="productSearchInput" placeholder="Pesquisar produtos..." class="w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div id="productSelectionCheckboxes" class="max-h-80 overflow-y-auto mb-4 border border-slate-700 rounded-lg p-4">
                    </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button onclick="saveSelectedProducts()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-check-circle mr-2"></i> Confirmar
                    </button>
                    <button onclick="hideProductSelectionModal()" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-times-circle mr-2"></i> Fechar
                    </button>
                </div>
            </div>
        </div>
        
        <div id="reportByEventModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
            <div class="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
                <h3 class="text-xl font-semibold text-white mb-4 text-center">Relatório por Evento</h3>
                <div class="space-y-4">
                    <div>
                        <label for="reportEventSelect" class="block text-sm font-medium text-slate-300">Selecione o Evento:</label>
                        <select id="reportEventSelect" required class="mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 border-2">
                            <option value="">-- Selecione --</option>
                        </select>
                    </div>
                    <div class="flex justify-end gap-2 mt-4">
                        <button onclick="hideReportByEventModal()" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105">Cancelar</button>
                        <button onclick="generateEventReport()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-chart-line mr-2"></i> Gerar Relatório
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="textEditModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
            <div class="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-2xl">
                <h3 class="text-2xl font-semibold text-white mb-4 text-center">Editar Texto do E-mail/PDF</h3>
                <p class="text-slate-300 mb-4 text-center">Edite o texto abaixo. Ele será usado no corpo do e-mail e nos rodapés dos PDFs.</p>
                
                <textarea id="editableTextarea" class="w-full h-96 rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-4 border-2 resize-none overflow-y-auto focus:ring-blue-500 focus:border-blue-500"></textarea>
                
                <div class="flex justify-end gap-2 mt-4">
                    <button id="saveTextBtn" onclick="saveEditableText()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-save mr-2"></i> Salvar Texto
                    </button>
                    <button onclick="hideTextEditModal()" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-times-circle mr-2"></i> Cancelar
                    </button>
                </div>
            </div>
        </div>

        <div id="toast" class="fixed bottom-4 right-4 bg-slate-800 text-white px-4 py-2 rounded-lg shadow-lg hidden">
            <p id="toast-message"></p>
        </div>
    </div>

    <script type="module">
        // Importações do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // IMPORTADO: writeBatch para transação de edição de ID
        import { getFirestore, doc, onSnapshot, collection, addDoc, updateDoc, deleteDoc, getDocs, where, query, setLogLevel, writeBatch, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais do ambiente Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDrylctq94XX2xDMROiC23KWCYVNuLbAEQ",
            authDomain: "vendaval-6eb23.firebaseapp.com",
            projectId: "vendaval-6eb23",
            storageBucket: "vendaval-6eb23.firebase-app.com",
            messagingSenderId: "1026188233889",
            appId: "1:1026188233889:web:3f25a06dafafa12f48f4e0",
            measurementId: "G-PPVFR86MV6"
        };
        
        // Inicialização do Firebase
        let app, db, auth, userId;
        let isAuthReady = false;
        let currentSaleId = null;
        let currentEditingClientId = null;
        let currentEditingProductId = null; // Novo ID para o produto a ser editado
        // NOVO: ID da venda que está sendo editada no modal de ID
        let currentEditingSaleId = null; 
        
        // Guarda os produtos selecionados para uma nova venda
        let newSaleSelectedProducts = {};
        // Guarda os produtos selecionados para uma venda sendo editada
        let editSaleSelectedProducts = {};

        // Variável de estado para o modo de edição no modal de pagamento
        let isEditingProductsInPaymentModal = false;

        // Variável para armazenar o texto editável (agora é texto simples)
        let editableText = `POR FAVOR CONFIRA TODOS OS DETALHES DO SEU PEDIDO
→ Esteja ciente do(s) produto(s) que está comprando.
Após o fechamento do pedido não há opção de desistência ou troca.
→ Em caso de desistência, a responsabilidade em repassar o pedido para outra pessoa é do cliente.
(OS PAGAMENTOS DEVEM SER CUMPRIDOS CONFORME CONSTA NO PEDIDO.
EM CASO DE ATRASO HAVERÁ MULTA. Evite atrasos!)
→ Analise as datas de pagamento para que não haja atraso.
→ Se preferir efetuar os pagamentos antes das datas estabelecidas e valores maiores que os estipulados nas parcelas para quitar antes do prazo, fique à vontade.
→ Em caso de desistência, você poderá repassar seu pedido para qualquer pessoa e nos informar o contato da pessoa que irá recebê-lo.
→ Seus abadás serão entregues na semana do evento em Natal (Ponta Negra) – Hotel Happy Ponta Negra Express.
→ Informações Complementares:
CORES DOS ABADÁS: somente serão divulgadas no primeiro dia de entregas, na semana do evento.
ORDEM DE APRESENTAÇÃO E HORÁRIO DAS ATRAÇÕES: só serão divulgados uma semana antes do evento.
Desde já, muito obrigado!
Comissário Valeriano Sousa
(85) 99645.7713 – E-mail: souasa@uol.com.br
Atendimento de segunda a sexta das 9h às 19h
VendaVal Store, há 20 anos investindo na satisfação do cliente`;

        async function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                document.getElementById('setup-instructions').classList.remove('hidden');
                console.error("Firebase config não fornecido. O aplicativo não funcionará corretamente.");
                return;
            } else {
                document.getElementById('setup-instructions').classList.add('hidden');
            }

            try {
                setLogLevel('debug');
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('login-section').classList.add('hidden');
                        document.getElementById('main-content').classList.remove('hidden');
                        document.getElementById('connection-status').classList.remove('hidden');
                        document.getElementById('status-message').innerHTML = `Sistema Pronto! Seu ID de usuário: <span id="user-id-value" class="font-mono text-white break-all">${userId}</span>`;
                        document.getElementById('connection-status').classList.add('bg-green-800', 'text-green-100');
                        toggleFormButtons(true);
                        await loadEditableText();
                        listenToCollections();
                    } else {
                        isAuthReady = false;
                        document.getElementById('main-content').classList.add('hidden');
                        document.getElementById('login-section').classList.remove('hidden');
                        toggleFormButtons(false);
                    }
                });
                
            } catch (e) {
                console.error("Erro ao inicializar o Firebase:", e);
                showToast("Erro ao conectar ao banco de dados.", 'warning');
            }
        }
        
        // --- Funções para o editor de texto rico ---
        // A barra de ferramentas foi removida, então essas funções não são mais necessárias
        window.formatText = (command) => {
            // No-op
        };

        window.alignText = (command) => {
             // No-op
        };

        window.changeColor = (color) => {
            // No-op
        };

        // --- Funções para o texto editável ---
        async function loadEditableText() {
            if (!isAuthReady) return;
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/config`, 'email-text');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    // O texto agora é salvo como texto simples no banco de dados.
                    editableText = docSnap.data().text;
                }
            } catch (e) {
                console.error("Erro ao carregar o texto editável:", e);
                showToast("Erro ao carregar o texto editável.", 'warning');
            }
        }

        window.openTextEditModal = () => {
            // Agora usa o value da textarea
            document.getElementById('editableTextarea').value = editableText;
            document.getElementById('textEditModal').classList.remove('hidden');
        };

        window.hideTextEditModal = () => {
            document.getElementById('textEditModal').classList.add('hidden');
        };

        window.saveEditableText = async () => {
            if (!isAuthReady) {
                showToast('Aguarde a conexão com o banco de dados...', 'warning');
                return;
            }
            // Obtém o valor da textarea, que é texto simples
            const newText = document.getElementById('editableTextarea').value;
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/config`, 'email-text');
                await setDoc(docRef, { text: newText });
                editableText = newText;
                showToast("Texto salvo com sucesso!");
                hideTextEditModal();
            } catch (e) {
                console.error("Erro ao salvar o texto:", e);
                showToast("Erro ao salvar o texto.", 'warning');
            }
        };

        // --- Funções de Lembrar Email ---
        function loadRememberedEmail() {
            const rememberedEmail = localStorage.getItem('rememberedEmail');
            const rememberCheckbox = document.getElementById('rememberEmail');
            const emailInput = document.getElementById('email');
            
            if (rememberedEmail) {
                emailInput.value = rememberedEmail;
                rememberCheckbox.checked = true;
            }
        }

        function saveEmailIfRemembered(email) {
            const rememberCheckbox = document.getElementById('rememberEmail');
            if (rememberCheckbox.checked) {
                localStorage.setItem('rememberedEmail', email);
            } else {
                localStorage.removeItem('rememberedEmail');
            }
        }

        // Carregar email salvo quando a página carregar
        document.addEventListener('DOMContentLoaded', loadRememberedEmail);

        // --- Funções de Login e Logout ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                saveEmailIfRemembered(email);
                showToast("Login bem-sucedido!");
            } catch (e) {
                console.error("Erro no login:", e);
                if (e.code === 'auth/operation-not-allowed') {
                    showToast("Erro: A autenticação por E-mail/Senha não está ativada. Por favor, ative-a nas configurações de autenticação do seu console do Firebase.", 'warning');
                } else {
                    showToast("Login ou senha incorretos.", 'warning');
                }
            }
        });

        document.getElementById('createAdminBtn').addEventListener('click', async () => {
            const email = "admin@vendaval.com";
            const password = "VendavalStoreasa";
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showToast("Conta de administrador criada com sucesso!");
            } catch (e) {
                console.error("Erro ao criar conta:", e);
                if (e.code === 'auth/email-already-in-use') {
                    showToast("Este email já está em uso.", 'warning');
                } else if (e.code === 'auth/invalid-email') {
                    showToast("O email não é válido.", 'warning');
                } else if (e.code === 'auth/weak-password') {
                    showToast("A senha é muito fraca. Mínimo de 6 caracteres.", 'warning');
                } else if (e.code === 'auth/operation-not-allowed') {
                    showToast("Erro: A autenticação por E-mail/Senha não está ativada. Por favor, ative-a nas configurações de autenticação do seu console do Firebase.", 'warning');
                } else {
                    showToast("Erro ao criar conta. Verifique os dados e o console.", 'warning');
                }
            }
        });
        
        window.logout = async () => {
            await signOut(auth);
            showToast("Sessão encerrada com sucesso!");
        }

        function toggleFormButtons(enable) {
            document.querySelectorAll('.form-button').forEach(button => {
                button.disabled = !enable;
                if (enable) {
                    button.classList.remove('form-disabled');
                } else {
                    button.classList.add('form-disabled');
                }
            });
        }
        
        toggleFormButtons(false);
        initializeFirebase();

        // --- Funções de UI ---
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.nav-button').forEach(button => {
                button.classList.remove('active');
            });
            const activeButton = document.querySelector(`[onclick="showSection('${sectionId}')"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            if (sectionId === 'vendas') {
                updateSaleTotal('new-sale');
            }
        }
        
        showSection('dashboard');

        // --- Funções do Firestore (CRUD) ---
        let clients = [];
        let products = [];
        let sales = [];
        let events = [];

        function listenToCollections() {
            if (!isAuthReady) {
                console.warn("Autenticação não concluída. Abortando escuta de dados.");
                return;
            }

            const clientsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/clientes`);
            onSnapshot(clientsCollectionRef, (querySnapshot) => {
                clients = [];
                querySnapshot.forEach((doc) => {
                    clients.push({ id: doc.id, ...doc.data() });
                });
                clients.sort((a, b) => a.name.localeCompare(b.name));
                renderClients();
                populateClientSelect();
                renderBirthdays();
            });

            const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/produtos`);
            onSnapshot(productsCollectionRef, (querySnapshot) => {
                products = [];
                querySnapshot.forEach((doc) => {
                    products.push({ id: doc.id, ...doc.data() });
                });
                products.sort((a, b) => a.name.localeCompare(b.name)); // Ordena os produtos por nome em ordem alfabética
                renderProducts();
                updateTotalStockValue();
            });
            
            const eventsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/eventos`);
            onSnapshot(eventsCollectionRef, (querySnapshot) => {
                events = [];
                querySnapshot.forEach((doc) => {
                    events.push({ id: doc.id, ...doc.data() });
                });
                events.sort((a, b) => a.name.localeCompare(b.name)); // Ordena os eventos por nome em ordem alfabética
                renderEvents();
                populateEventSelect();
                populateReportEventSelect(); // NOVO: Preenche a lista do modal de relatórios por evento
            });

            const salesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/vendas`);
            onSnapshot(salesCollectionRef, (querySnapshot) => {
                sales = [];
                querySnapshot.forEach((doc) => {
                    sales.push({ id: doc.id, ...doc.data() });
                });
                sales.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); // Ordena as vendas pela data de criação em ordem decrescente
                renderSales();
                updateDashboard();
            });
        }

        /**
         * Função auxiliar para normalizar CPF (remove pontos, hífens e espaços)
         */
        function normalizeCPF(cpf) {
            if (!cpf) return '';
            return cpf.replace(/[.\-\s]/g, '').trim();
        }

        /**
         * FUNÇÃO MODIFICADA: Adiciona verificação de CPF único antes de cadastrar.
         * Normaliza o CPF para garantir comparação correta.
         */
        async function addClient(clientData) {
            if (!isAuthReady) {
                showToast('Aguarde a conexão com o banco de dados...', 'warning');
                return;
            }
            try {
                const clientsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/clientes`);
                
                // Normaliza o CPF (remove pontos, hífens e espaços)
                const normalizedCPF = normalizeCPF(clientData.cpf);
                
                // Valida se o CPF tem 11 dígitos após normalização
                if (normalizedCPF.length !== 11 || !/^\d+$/.test(normalizedCPF)) {
                    showToast("Erro: CPF inválido. O CPF deve conter exatamente 11 dígitos.", 'warning');
                    return;
                }
                
                // 1. Cria a query para buscar por um cliente com o mesmo CPF normalizado
                const cpfQuery = query(clientsCollectionRef, where("cpf", "==", normalizedCPF));
                const querySnapshot = await getDocs(cpfQuery);

                if (!querySnapshot.empty) {
                    // 2. Se a query retornar resultados, o CPF já está em uso.
                    showToast("Erro: Um cliente com este CPF já está cadastrado. CPF deve ser único.", 'warning');
                    return; // Aborta a adição
                }

                // 3. Se não houver resultados, adiciona o novo cliente com CPF normalizado
                clientData.cpf = normalizedCPF;
                await addDoc(clientsCollectionRef, clientData);
                showToast("Cliente adicionado com sucesso!");
            } catch (e) {
                console.error("Erro ao adicionar cliente:", e);
                showToast("Erro ao adicionar cliente.", 'warning');
            }
        }
        
        async function addProduct(productData) {
            if (!isAuthReady) {
                showToast('Aguarde a conexão com o banco de dados...', 'warning');
                return;
            }
            try {
                const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/produtos`);
                const productsSnapshot = await getDocs(productsCollectionRef);
                const currentCodes = productsSnapshot.docs.map(doc => doc.data().code || 0);
                const maxCode = currentCodes.length > 0 ? Math.max(...currentCodes) : 0;
                
                const newProductData = {
                    ...productData,
                    code: maxCode + 1
                };
                
                await addDoc(productsCollectionRef, newProductData);
                showToast("Produto adicionado com sucesso!");
            } catch (e) {
                console.error("Erro ao adicionar produto:", e);
                showToast("Erro ao adicionar produto.", 'warning');
            }
        }
        
        async function updateProduct(productId, productData) {
            if (!isAuthReady) {
                showToast('Aguarde a conexão com o banco de dados...', 'warning');
                return;
            }
            try {
                const productDocRef = doc(db, `artifacts/${appId}/users/${userId}/produtos`, productId);
                await updateDoc(productDocRef, productData);
                showToast("Produto atualizado com sucesso!");
                hideEditProductModal();
            } catch (e) {
                console.error("Erro ao atualizar produto:", e);
                showToast("Erro ao atualizar produto.", 'warning');
            }
        }

        async function deleteProduct(productId) {
            if (!isAuthReady) {
                showToast('Aguarde a conexão com o banco de dados...', 'warning');
                return;
            }
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/produtos`, productId));
                showToast("Produto deletado com sucesso!");
            } catch (e) {
                console.error("Erro ao deletar produto:", e);
                showToast("Erro ao deletar produto.", 'warning');
            }
        }
        
        async function addEvent(eventData) {
            if (!isAuthReady) {
                showToast('Aguarde a conexão com o banco de dados...', 'warning');
                return;
            }
            try {
                const eventsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/eventos`);
                await addDoc(eventsCollectionRef, eventData);
                showToast("Evento adicionado com sucesso!");
            } catch (e) {
                console.error("Erro ao adicionar evento:", e);
                showToast("Erro ao adicionar evento.", 'warning');
            }
        }

        async function deleteEvent(eventId) {
            if (!isAuthReady) {
                showToast('Aguarde a conexão com o banco de dados...', 'warning');
                return;
            }
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/eventos`, eventId));
                showToast("Evento deletado com sucesso!");
            } catch (e) {
                console.error("Erro ao deletar evento:", e);
                showToast("Erro ao deletar evento.", 'warning');
            }
        }
        
        async function updateProductStockAndAddSale(saleData) {
            if (!isAuthReady) {
                showToast('Aguarde a conexão com o banco de dados...', 'warning');
                return;
            }

            const batch = writeBatch(db);

            // 1. Atualiza o estoque dos produtos
            const productsSold = saleData.products;
            for (const productSold of productsSold) {
                const productId = productSold.productId;
                const quantitySold = productSold.quantity;

                const product = products.find(p => p.id === productId);
                if (product) {
                    const newStock = (product.stock || 0) - quantitySold;
                    if (newStock < 0) {
                        showToast(`Estoque insuficiente para o produto: ${product.name}`, 'warning');
                        return; // Aborta a operação
                    }
                    const productDocRef = doc(db, `artifacts/${appId}/users/${userId}/produtos`, productId);
                    batch.update(productDocRef, { stock: newStock });
                }
            }

            // 2. Cria a nova venda
            const salesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/vendas`);
            const salesSnapshot = await getDocs(salesCollectionRef);
            const currentYear = new Date().getFullYear();
            
            const lastSaleId = salesSnapshot.docs
                .map(doc => parseInt(doc.id, 10))
                .filter(id => id.toString().startsWith(currentYear.toString()))
                .sort((a, b) => b - a)[0] || 0;
            
            let newId;
            if (lastSaleId > 0) {
                const lastNumber = parseInt(lastSaleId.toString().substring(4), 10);
                newId = `${currentYear}${String(lastNumber + 1).padStart(3, '0')}`;
            } else {
                newId = `${currentYear}201`;
            }

            const saleDocRef = doc(db, `artifacts/${appId}/users/${userId}/vendas`, newId);
            batch.set(saleDocRef, saleData);

            // 3. Commit as alterações
            try {
                await batch.commit();
                showToast("Venda adicionada e estoque atualizado com sucesso!");
            } catch (e) {
                console.error("Erro ao adicionar venda e atualizar estoque:", e);
                showToast("Erro ao adicionar venda e atualizar estoque.", 'warning');
            }
        }
        
        async function revertStockFromSale(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale || !sale.products || sale.status === 'cancelado') {
                return;
            }
        
            const batch = writeBatch(db);
            const productUpdates = {};
        
            sale.products.forEach(productSold => {
                const updatedProduct = products.find(p => p.id === productSold.productId);
                if (updatedProduct) {
                    productUpdates[productSold.productId] = (productUpdates[productSold.productId] || 0) + productSold.quantity;
                }
            });
        
            for (const productId in productUpdates) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    const newStock = (product.stock || 0) + productUpdates[productId];
                    const productDocRef = doc(db, `artifacts/${appId}/users/${userId}/produtos`, productId);
                    batch.update(productDocRef, { stock: newStock });
                }
            }
        
            try {
                await batch.commit();
                showToast("Estoque da venda revertido com sucesso!");
            } catch (e) {
                console.error("Erro ao reverter o estoque:", e);
                showToast("Erro ao reverter o estoque. Verifique o console.", 'warning');
            }
        }
        
        async function deleteSale(saleId) {
            if (!isAuthReady) {
                showToast('Aguarde a conexão com o banco de dados...', 'warning');
                return;
            }
            try {
                await revertStockFromSale(saleId);
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/vendas`, saleId));
                showToast("Venda deletada com sucesso! O estoque foi revertido.");
            } catch (e) {
                console.error("Erro ao deletar venda:", e);
                showToast("Erro ao deletar venda.", 'warning');
            }
        }
        
        async function deleteClientAndSales(clientId) {
            if (!isAuthReady) {
                showToast('Aguarde a conexão com o banco de dados...', 'warning');
                return;
            }
            try {
                const salesQuery = query(collection(db, `artifacts/${appId}/users/${userId}/vendas`), where("clientId", "==", clientId));
                const salesSnapshot = await getDocs(salesQuery);
                salesSnapshot.forEach(async (saleDoc) => {
                    await revertStockFromSale(saleDoc.id);
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/vendas`, saleDoc.id));
                });

                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/clientes`, clientId));
                showToast("Cliente e suas vendas deletados com sucesso!");
            } catch (e) {
                console.error("Erro ao deletar cliente e vendas:", e);
                showToast("Erro ao deletar cliente e vendas.", 'warning');
            }
        }

        /**
         * FUNÇÃO MODIFICADA: Adiciona verificação de CPF único ao editar.
         * Garante que o novo CPF não pertença a nenhum outro cliente, exceto o atual.
         * Normaliza o CPF para garantir comparação correta.
         */
        async function updateClient(clientId, clientData) {
            if (!isAuthReady) {
                showToast('Aguarde a conexão com o banco de dados...', 'warning');
                return;
            }
            try {
                const clientsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/clientes`);

                // Normaliza o CPF (remove pontos, hífens e espaços)
                const normalizedCPF = normalizeCPF(clientData.cpf);
                
                // Valida se o CPF tem 11 dígitos após normalização
                if (normalizedCPF.length !== 11 || !/^\d+$/.test(normalizedCPF)) {
                    showToast("Erro: CPF inválido. O CPF deve conter exatamente 11 dígitos.", 'warning');
                    return;
                }

                // 1. Cria a query para buscar por clientes com o novo CPF normalizado
                const cpfQuery = query(clientsCollectionRef, where("cpf", "==", normalizedCPF));
                const querySnapshot = await getDocs(cpfQuery);

                let cpfAlreadyExists = false;
                querySnapshot.forEach(doc => {
                    // 2. Se a query retornar um documento que NÃO é o cliente que está sendo editado (clientId)
                    if (doc.id !== clientId) { 
                        cpfAlreadyExists = true;
                    }
                });

                if (cpfAlreadyExists) {
                    showToast("Erro: O CPF inserido já pertence a outro cliente cadastrado.", 'warning');
                    return; // Aborta a atualização
                }

                // 3. Se o CPF for único, atualiza o cliente com CPF normalizado
                clientData.cpf = normalizedCPF;
                const clientDocRef = doc(db, `artifacts/${appId}/users/${userId}/clientes`, clientId);
                await updateDoc(clientDocRef, clientData);
                showToast("Dados do cliente atualizados com sucesso!");
                hideEditClientModal();
            } catch (e) {
                console.error("Erro ao atualizar cliente:", e);
                showToast("Erro ao atualizar cliente.", 'warning');
            }
        }
        
        // --- Funções de Renderização da UI ---
        function renderClients(filteredClients = clients) {
            const tableBody = document.getElementById('clientsTableBody');
            tableBody.innerHTML = '';
            filteredClients.forEach(client => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-700 transition-colors';
                row.innerHTML = `
                    <td class="py-3 px-4">${client.name}</td>
                    <td class="py-3 px-4">${client.cpf}</td>
                    <td class="py-3 px-4">${client.phone || '-'} / ${client.email || '-'}</td>
                    <td class="py-3 px-4">${client.emergencyContactName || '-'}</td>
                    <td class="py-3 px-4">${client.emergencyContact || '-'}</td>
                    <td class="py-3 px-4 text-sm flex gap-2">
                        <button onclick="openEditClientModal('${client.id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-medium py-1 px-3 rounded-md shadow-md transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="showConfirmationModal('delete-client', '${client.id}')" class="bg-red-500 hover:bg-red-600 text-white text-sm font-medium py-1 px-3 rounded-md shadow-md transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        document.getElementById('clientSearchInput').addEventListener('keyup', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredClients = clients.filter(c => 
                c.name.toLowerCase().includes(searchTerm) || 
                (c.cpf || '').toLowerCase().includes(searchTerm)
            );
            renderClients(filteredClients);
        });

        function renderBirthdays() {
            const birthdaysList = document.getElementById('birthdaysList');
            birthdaysList.innerHTML = '';
            const currentMonth = new Date().getMonth() + 1;
            const currentDay = new Date().getDate();

            const birthdaysThisMonth = clients.filter(client => {
                if (!client.birthDate) return false;
                const birthDate = new Date(client.birthDate + 'T00:00:00'); // Adiciona 'T00:00:00' para evitar problemas de fuso horário
                return birthDate.getMonth() + 1 === currentMonth;
            }).sort((a, b) => {
                const dateA = new Date(a.birthDate + 'T00:00:00').getDate();
                const dateB = new Date(b.birthDate + 'T00:00:00').getDate();
                return dateA - dateB;
            });

            if (birthdaysThisMonth.length === 0) {
                birthdaysList.innerHTML = '<p class="text-slate-400">Nenhum aniversariante neste mês.</p>';
                return;
            }

            birthdaysThisMonth.forEach(client => {
                const birthDate = new Date(client.birthDate + 'T00:00:00');
                const birthDay = birthDate.getDate();
                const isToday = birthDay === currentDay;
                
                const card = document.createElement('div');
                card.className = `bg-slate-900 p-4 rounded-lg shadow-inner ${isToday ? 'border-2 border-yellow-500' : ''}`;
                card.innerHTML = `
                    <p class="text-lg font-semibold text-white">${client.name} ${isToday ? '<i class="fas fa-birthday-cake text-yellow-500 ml-2"></i>' : ''}</p>
                    <p class="text-slate-400 text-sm">Aniversário: ${birthDay}/${currentMonth}</p>
                    <p class="text-slate-400 text-sm">Telefone: ${client.phone || '-'}</p>
                `;
                birthdaysList.appendChild(card);
            });
        }
        
        function renderProducts(filteredProducts = products) {
            const tableBody = document.getElementById('productsTableBody');
            tableBody.innerHTML = '';
            filteredProducts.forEach(product => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-700 transition-colors';
                row.innerHTML = `
                    <td class="py-3 px-4">${product.code}</td>
                    <td class="py-3 px-4">${product.name}</td>
                    <td class="py-3 px-4">R$ ${product.cost ? product.cost.toFixed(2).replace('.', ',') : '0,00'}</td>
                    <td class="py-3 px-4 text-white">${product.stock || 0}</td>
                    <td class="py-3 px-4 text-sm flex gap-2">
                        <button onclick="addStockQuickly('${product.id}', 1)" class="bg-green-500 hover:bg-green-600 text-white text-sm font-medium py-1 px-3 rounded-md shadow-md transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button onclick="openEditProductModal('${product.id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-medium py-1 px-3 rounded-md shadow-md transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="showConfirmationModal('delete-product', '${product.id}')" class="bg-red-500 hover:bg-red-600 text-white text-sm font-medium py-1 px-3 rounded-md shadow-md transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        document.getElementById('productSearchInput').addEventListener('keyup', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredProducts = products.filter(p =>
                p.name.toLowerCase().includes(searchTerm) ||
                p.code.toString().includes(searchTerm)
            );
            renderProducts(filteredProducts);
        });
        
        function renderEvents(filteredEvents = events) {
            const tableBody = document.getElementById('eventsTableBody');
            tableBody.innerHTML = '';
            filteredEvents.forEach(event => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-700 transition-colors';
                row.innerHTML = `
                    <td class="py-3 px-4">${event.name}</td>
                    <td class="py-3 px-4 text-sm flex gap-2">
                        <button onclick="showConfirmationModal('delete-event', '${event.id}')" class="bg-red-500 hover:bg-red-600 text-white text-sm font-medium py-1 px-3 rounded-md shadow-md transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        document.getElementById('eventSearchInput').addEventListener('keyup', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredEvents = events.filter(event =>
                event.name.toLowerCase().includes(searchTerm)
            );
            renderEvents(filteredEvents);
        });

        function populateClientSelect() {
            const select = document.getElementById('saleClient');
            const editClientSelect = document.getElementById('editSaleClient');
            
            select.innerHTML = '<option value="">Selecione um cliente</option>';
            if (editClientSelect) {
                editClientSelect.innerHTML = '<option value="">Selecione um cliente</option>';
            }

            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                select.appendChild(option);

                if (editClientSelect) {
                    const editOption = option.cloneNode(true);
                    editClientSelect.appendChild(editOption);
                }
            });
        }
        
        function populateEventSelect() {
            const select = document.getElementById('saleEvent');
            
            select.innerHTML = '<option value="">Selecione um evento</option>';
            events.forEach(event => {
                const option = document.createElement('option');
                option.value = event.id;
                option.textContent = event.name;
                select.appendChild(option);
            });
        }
        
        // NOVO: Preenche o select do modal de relatório por evento
        function populateReportEventSelect() {
            const select = document.getElementById('reportEventSelect');
            select.innerHTML = '<option value="">-- Selecione --</option>';
            events.forEach(event => {
                const option = document.createElement('option');
                option.value = event.id;
                option.textContent = event.name;
                select.appendChild(option);
            });
        }

        function populateEditEventSelect(currentEventId) {
            const select = document.getElementById('editSaleEventSelect');
            select.innerHTML = '<option value="">Selecione um evento</option>';
            events.forEach(event => {
                const option = document.createElement('option');
                option.value = event.id;
                option.textContent = event.name;
                if (event.id === currentEventId) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        function updateSaleTotal(mode) {
            let total = 0;
            const productList = mode === 'new-sale' ? newSaleSelectedProducts : editSaleSelectedProducts;
            
            Object.values(productList).forEach(p => {
                const quantity = p.quantity || 0;
                const value = p.value || 0;
                total += quantity * value;
            });

            const displayElement = mode === 'new-sale' ? document.getElementById('saleTotalValue') : document.getElementById('editSaleTotalValue');
            if (displayElement) {
                if (mode === 'new-sale') {
                     displayElement.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
                } else {
                     // NOVO: Atualiza o valor do input, que agora é editável
                     displayElement.value = total.toFixed(2);
                }
            }
        }
        
        function renderNewSaleProducts() {
            const list = document.getElementById('newSaleProductsList');
            list.innerHTML = '';
            if (Object.keys(newSaleSelectedProducts).length === 0) {
                list.innerHTML = '<p class="text-slate-400">Nenhum produto adicionado.</p>';
                return;
            }
            
            Object.keys(newSaleSelectedProducts).forEach(productId => {
                const product = products.find(p => p.id === productId);
                const listItem = document.createElement('div');
                listItem.className = 'bg-slate-700 rounded-lg p-2 flex flex-col sm:flex-row justify-between items-start sm:items-center';
                
                const productInfo = product ? `<span class="text-white">${product.name}</span>` : `<span class="text-red-500">Produto removido (ID: ${productId})</span>`;

                listItem.innerHTML = `
                    ${productInfo}
                    <div class="flex items-center mt-2 sm:mt-0">
                        <label class="text-sm text-slate-400 mr-2">Qtd:</label>
                        <input type="number" data-product-id="${productId}" data-type="quantity" value="${newSaleSelectedProducts[productId].quantity}" min="1" max="10" class="new-sale-product-quantity w-16 text-right rounded-md border-slate-600 bg-slate-900 text-white shadow-sm p-1 text-sm border-2 mr-4">
                        <label class="text-sm text-slate-400 mr-2">Lote:</label>
                        <input type="number" data-product-id="${productId}" data-type="lot" value="${newSaleSelectedProducts[productId].lot || ''}" min="1" max="10" class="new-sale-product-lot w-24 text-right rounded-md border-slate-600 bg-slate-900 text-white shadow-sm p-1 text-sm border-2 mr-4">
                        <label class="text-sm text-slate-400 mr-2">Valor:</label>
                        <input type="number" step="0.01" data-product-id="${productId}" data-type="value" value="${newSaleSelectedProducts[productId].value}" min="0.01" class="new-sale-product-value w-24 text-right rounded-md border-slate-600 bg-slate-900 text-white shadow-sm p-1 text-sm border-2">
                        <button type="button" onclick="removeProductFromNewSale('${productId}')" class="text-red-500 hover:text-red-700 font-bold ml-2">
                           <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                list.appendChild(listItem);
            });

            document.querySelectorAll('#newSaleProductsList input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const productId = e.target.dataset.productId;
                    const type = e.target.dataset.type;
                    let value = e.target.value;

                    if (type === 'quantity' || type === 'lot') {
                        value = parseInt(value);
                        if (isNaN(value) || value < 1) value = 1;
                        if (value > 10) value = 10;
                        e.target.value = value;
                    } else if (type === 'value') {
                        value = parseFloat(value);
                        if (isNaN(value) || value < 0.01) value = 0.01;
                        e.target.value = value.toFixed(2);
                    }

                    newSaleSelectedProducts[productId][type] = value;
                    updateSaleTotal('new-sale');
                });
            });
        }

        window.removeProductFromNewSale = (productId) => {
            delete newSaleSelectedProducts[productId];
            renderNewSaleProducts();
            updateSaleTotal('new-sale');
        };
        
        function renderSales(filteredSales = sales) {
            const tableBody = document.getElementById('salesTableBody');
            tableBody.innerHTML = '';
            filteredSales.forEach(sale => {
                const client = clients.find(c => c.id === sale.clientId);
                const clientName = client ? client.name : 'Cliente Removido';
                // Usa o totalValue salvo no banco (o valor da nota)
                const totalValue = sale.totalValue ? sale.totalValue.toFixed(2).replace('.', ',') : '0,00'; 
                const createdAt = formatDateAsDDMMYYYY(sale.createdAt);
                
                let statusColor = '';
                let statusText = '';
                
                if (sale.status === 'quitado') {
                    statusColor = 'bg-green-600';
                    statusText = 'Quitado';
                } else if (sale.status === 'cancelado') {
                    statusColor = 'bg-red-500';
                    statusText = 'Cancelada';
                } else {
                    const hasOverdue = sale.parcels && sale.parcels.some(p => p.status !== 'pago' && new Date(p.dueDate) < new Date());
                    if (hasOverdue) {
                        statusColor = 'bg-orange-500';
                        statusText = 'Vencida';
                    } else {
                        statusColor = 'bg-blue-500';
                        statusText = 'Em Andamento';
                    }
                }

                const productsList = (sale.products || [])
                    .map(item => {
                        const product = products.find(p => p.id === item.productId);
                        const productName = product ? product.name : 'Removido';
                        const lot = item.lot || 'N/A';
                        return `
                            <div class="mb-1 text-sm text-slate-300">
                                <strong>${productName}</strong> (Qtd: ${item.quantity}, Lote: ${lot})
                            </div>
                        `;
                    })
                    .join('');

                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-700 transition-colors';
                row.innerHTML = `
                    <td class="py-3 px-4 text-sm font-medium text-white">${sale.id}</td>
                    <td class="py-3 px-4 text-slate-300">${clientName}</td>
                    <td class="py-3 px-4">${productsList}</td>
                    <td class="py-3 px-4 text-green-500">R$ ${totalValue}</td>
                    <td class="py-3 px-4 text-slate-300">${createdAt}</td>
                    <td class="py-3 px-4"><span class="inline-block rounded-full px-2 py-1 text-xs font-semibold text-white ${statusColor}">${statusText}</span></td>
                    <td class="py-3 px-4 text-sm flex gap-2">
                        <button onclick="openPaymentModal('${sale.id}')" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-1 px-3 rounded-md shadow-md transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-info-circle"></i>
                        </button>
                        <!-- NOVO BOTÃO DE EDIÇÃO DE ID -->
                        <button onclick="openEditSaleIdModal('${sale.id}')" class="bg-gray-500 hover:bg-gray-600 text-white text-sm font-medium py-1 px-3 rounded-md shadow-md transition-all duration-300 transform hover:scale-105" title="Editar ID da Venda">
                            <i class="fas fa-key"></i>
                        </button>
                        <button onclick="enviarEmail('${sale.id}')" class="bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium py-1 px-3 rounded-md shadow-md transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-envelope"></i>
                        </button>
                        <button onclick="visualizarPdf('${sale.id}')" class="bg-yellow-600 hover:bg-yellow-700 text-white text-sm font-medium py-1 px-3 rounded-md shadow-md transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-file-pdf"></i>
                        </button>
                        <button onclick="showConfirmationModal('cancel-sale', '${sale.id}')" class="bg-orange-500 hover:bg-orange-600 text-white text-sm font-medium py-1 px-3 rounded-md shadow-md transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-times-circle"></i>
                        </button>
                        <button onclick="showConfirmationModal('delete-sale', '${sale.id}')" class="bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-1 px-3 rounded-md shadow-md transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        document.getElementById('saleSearchInput').addEventListener('keyup', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredSales = sales.filter(s => 
                s.id.toLowerCase().includes(searchTerm) || 
                (clients.find(c => c.id === s.clientId)?.name || '').toLowerCase().includes(searchTerm) ||
                (s.products || []).some(p => (products.find(pr => pr.id === p.productId)?.name || '').toLowerCase().includes(searchTerm))
            );
            renderSales(filteredSales);
        });

        function updateDashboard() {
            const totalSalesCount = sales.length;
            const clientsCount = clients.length;
            const productsCount = products.length;
            
            let totalSalesOriginalValue = 0; // O valor total da VENDA (Valor da Nota, que é o campo totalValue)
            let totalReceivedValue = 0;
            const paidSales = [];
            const inProgressSales = [];
            const overdueSales = [];
            const canceledSales = [];

            sales.forEach(sale => {
                // Verifica se a venda está cancelada primeiro
                if (sale.status === 'cancelado') {
                    canceledSales.push(sale);
                    return; // Não inclui vendas canceladas nos cálculos
                }

                // Usa o totalValue salvo no documento (o Valor da Nota)
                const saleTotalNoteValue = sale.totalValue || 0;
                totalSalesOriginalValue += saleTotalNoteValue;
                
                // Calcula o valor total remanescente das parcelas (apenas parcelas NÃO pagas)
                const totalRemainingParcels = sale.parcels.reduce((sum, p) => {
                    if (p.status !== 'pago') {
                        return sum + (p.value || 0);
                    }
                    return sum;
                }, 0);
                
                // O valor recebido é a diferença entre o total original da nota e o que resta a pagar
                totalReceivedValue += (saleTotalNoteValue - totalRemainingParcels);

                if (sale.status === 'quitado') {
                     paidSales.push(sale);
                } else {
                    const hasOverdue = sale.parcels && sale.parcels.some(p => p.status !== 'pago' && new Date(p.dueDate) < new Date() && p.value > 0); // Verifica se tem valor a pagar
                    if (hasOverdue) {
                        overdueSales.push(sale);
                    } else {
                        inProgressSales.push(sale);
                    }
                }
            });

            const totalPendingValue = totalSalesOriginalValue - totalReceivedValue; 
            
            document.getElementById('totalSalesValue').textContent = 'R$ ' + totalSalesOriginalValue.toFixed(2).replace('.', ',');
            document.getElementById('totalReceivedValue').textContent = 'R$ ' + totalReceivedValue.toFixed(2).replace('.', ',');
            document.getElementById('totalPendingValue').textContent = 'R$ ' + totalPendingValue.toFixed(2).replace('.', ',');
            
            document.getElementById('totalSalesCount').textContent = totalSalesCount;
            document.getElementById('totalRevenue').textContent = 'R$ ' + totalSalesOriginalValue.toFixed(2).replace('.', ',');
            document.getElementById('reportsTotalRevenue').textContent = 'R$ ' + totalSalesOriginalValue.toFixed(2).replace('.', ',');
            document.getElementById('paidSalesCount').textContent = paidSales.length;
            document.getElementById('inProgressSalesCount').textContent = inProgressSales.length;
            document.getElementById('overdueSalesCount').textContent = overdueSales.length;
            document.getElementById('canceledSalesCount').textContent = canceledSales.length;
            document.getElementById('pendingPaymentCount').textContent = inProgressSales.length + overdueSales.length; // Nova métrica
            document.getElementById('totalClientsCount').textContent = clientsCount;
            document.getElementById('totalProductsCount').textContent = productsCount;
        }
        
        function updateTotalStockValue() {
            const totalCost = products.reduce((sum, p) => sum + (p.cost || 0), 0);
            document.getElementById('totalStockValue').textContent = `R$ ${totalCost.toFixed(2).replace('.', ',')}`;
        }
        
        window.editTotalStockValue = () => {
            const currentValue = products.reduce((sum, p) => sum + (p.cost || 0), 0);
            const newValue = prompt("Digite o novo valor total de custo do estoque:", currentValue.toFixed(2));
            if (newValue !== null) {
                const newCost = parseFloat(newValue.replace(',', '.'));
                if (!isNaN(newCost) && newCost >= 0) {
                    showToast("Função de edição do valor total ainda não implementada para múltiplos produtos. Edite o custo de cada produto individualmente.");
                } else {
                    showToast("Valor inválido. Por favor, digite um número válido.", 'warning');
                }
            }
        };

        // --- Funções de Eventos dos Formulários ---
        document.getElementById('clientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const clientData = {
                name: document.getElementById('clientName').value,
                cpf: document.getElementById('clientCpf').value,
                phone: document.getElementById('clientPhone').value,
                email: document.getElementById('clientEmail').value,
                emergencyContactName: document.getElementById('clientEmergencyContactName').value,
                emergencyContact: document.getElementById('clientEmergencyContact').value,
                birthDate: document.getElementById('clientBirthDate').value,
                createdAt: new Date().toISOString()
            };
            await addClient(clientData);
            e.target.reset();
        });

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const productData = {
                name: document.getElementById('productName').value,
                cost: parseFloat(document.getElementById('productCost').value) || 0,
                stock: parseInt(document.getElementById('productStock').value) || 0,
                createdAt: new Date().toISOString()
            };
            await addProduct(productData);
            e.target.reset();
        });
        
        document.getElementById('editProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const productData = {
                name: document.getElementById('editProductName').value,
                cost: parseFloat(document.getElementById('editProductCost').value) || 0,
                stock: parseInt(document.getElementById('editProductStock').value) || 0,
            };
            await updateProduct(currentEditingProductId, productData);
        });

        document.getElementById('eventForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const eventData = {
                name: document.getElementById('eventName').value,
                createdAt: new Date().toISOString()
            };
            await addEvent(eventData);
            e.target.reset();
        });

        document.getElementById('salePaymentMethod').addEventListener('change', (e) => {
            const installmentsWrapper = document.getElementById('installmentsWrapper');
            if (e.target.value === 'pix-parcelado') {
                installmentsWrapper.classList.remove('hidden');
            } else {
                installmentsWrapper.classList.add('hidden');
            }
        });
        
        document.getElementById('saleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const clientId = document.getElementById('saleClient').value;
            const eventId = document.getElementById('saleEvent').value;
            const event = events.find(e => e.id === eventId);
            const eventName = event?.name || 'Evento não encontrado';

            const paymentMethod = document.getElementById('salePaymentMethod').value;
            const installments = (paymentMethod === 'pix-parcelado') ? parseInt(document.getElementById('saleInstallments').value) : 1;
            const totalValue = Object.values(newSaleSelectedProducts).reduce((sum, p) => sum + (p.quantity * p.value), 0);
            
            if (!clientId || Object.keys(newSaleSelectedProducts).length === 0) {
                showToast("Por favor, selecione um cliente e adicione pelo menos um produto.", 'warning');
                return;
            }
            if (totalValue <= 0) {
                showToast("O valor total da venda deve ser maior que zero.", 'warning');
                return;
            }

            // Verifica se há estoque suficiente antes de gerar a venda
            for (const productSold of Object.values(newSaleSelectedProducts)) {
                const productInStock = products.find(p => p.id === productSold.productId);

                if (!productInStock || (productInStock.stock || 0) < productSold.quantity) {
                    showToast(`Estoque insuficiente para o produto: ${productInStock.name}. O estoque atual é de ${productInStock.stock || 0} unidades.`, 'warning');
                    return;
                }
            }
            
            const parcels = [];
            const parcelValue = totalValue / installments;
            const today = new Date();
            
            for (let i = 1; i <= installments; i++) {
                const dueDate = new Date(today);
                // A primeira parcela é sempre hoje, as próximas são um mês depois.
                if (i > 1) {
                    dueDate.setMonth(today.getMonth() + i - 1);
                }
                parcels.push({
                    parcelNumber: i,
                    value: parcelValue,
                    dueDate: dueDate.toISOString(),
                    status: 'em andamento'
                });
            }
            
            const saleData = {
                clientId,
                eventId,
                eventName,
                totalValue, // Este é o valor ORIGINAL da nota (será atualizado no DB)
                paymentMethod,
                installments,
                products: Object.values(newSaleSelectedProducts),
                parcels,
                advancements: [], // Inicializa o array de adiantamentos
                status: 'em andamento',
                createdAt: new Date().toISOString()
            };
            
            await updateProductStockAndAddSale(saleData);
            e.target.reset();
            newSaleSelectedProducts = {};
            renderNewSaleProducts();
            updateSaleTotal('new-sale');
        });

        // --- Funções de Modals e Confirmações Personalizadas ---
        let currentAction, currentItemId;

        function showConfirmationModal(action, itemId) {
            currentAction = action;
            currentItemId = itemId;
            const modal = document.getElementById('modal');
            const message = document.getElementById('modal-message');

            if (action === 'delete-sale') {
                message.textContent = "Tem certeza que deseja excluir esta venda? Esta ação não pode ser desfeita.";
            } else if (action === 'delete-client') {
                message.textContent = "Tem certeza que deseja excluir este cliente e todas as suas vendas? Esta ação não pode ser desfeita.";
            } else if (action === 'delete-product') {
                 message.textContent = "Tem certeza que deseja excluir este produto? Esta ação não pode ser desfeita.";
            } else if (action === 'delete-event') {
                message.textContent = "Tem certeza que deseja excluir este evento? Esta ação não pode ser desfeita.";
            } else if (action === 'cancel-sale') {
                message.textContent = "Tem certeza que deseja cancelar esta venda?";
            }
            modal.classList.remove('hidden');
        }

        document.getElementById('modal-confirm-btn').addEventListener('click', async () => {
            if (currentAction === 'delete-sale') {
                await deleteSale(currentItemId);
            } else if (currentAction === 'delete-client') {
                await deleteClientAndSales(currentItemId);
            } else if (currentAction === 'delete-product') {
                await deleteProduct(currentItemId);
            } else if (currentAction === 'delete-event') {
                await deleteEvent(currentItemId);
            } else if (currentAction === 'cancel-sale') {
                try {
                    await revertStockFromSale(currentItemId);
                    const saleDocRef = doc(db, `artifacts/${appId}/users/${userId}/vendas`, currentItemId);
                    await updateDoc(saleDocRef, { status: 'cancelado' });
                    showToast("Status da venda atualizado para 'Cancelado'! O estoque foi revertido.");
                } catch (e) {
                    console.error("Erro ao cancelar venda:", e);
                    showToast("Erro ao cancelar venda.", 'warning');
                }
            }
            document.getElementById('modal').classList.add('hidden');
        });

        document.getElementById('modal-cancel-btn').addEventListener('click', () => {
            document.getElementById('modal').classList.add('hidden');
        });
        
        // NOVA FUNÇÃO: Renderiza a lista de adiantamentos no modal de pagamento
        function renderAdvancements(sale) {
            const advancementList = document.getElementById('advancementList');
            advancementList.innerHTML = '';
            
            const advancements = sale.advancements || [];

            if (advancements.length === 0) {
                advancementList.innerHTML = '<p class="text-slate-500 text-sm">Nenhum adiantamento registrado para esta venda.</p>';
                return;
            }

            advancements.forEach((adv, index) => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 border-b border-slate-700 last:border-b-0';
                
                item.innerHTML = `
                    <div>
                        <p class="text-sm font-medium text-white">Valor: R$ ${adv.value.toFixed(2).replace('.', ',')}</p>
                        <p class="text-xs text-slate-400">Data: ${formatDateAsDDMMYYYY(adv.date)}</p>
                    </div>
                    <button onclick="revertAdvancement('${sale.id}', ${index})" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-undo mr-1"></i> Reverter
                    </button>
                `;
                advancementList.appendChild(item);
            });
        }
        
        // ======================= FUNÇÃO MODIFICADA =======================
        window.openPaymentModal = (saleId) => {
            currentSaleId = saleId;
            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;

            // Carrega os dados da venda para o modal de pagamento/edição
            populateEditEventSelect(sale.eventId);
            // CORRIGIDO: Usa o totalValue salvo no DB para carregar o Valor Total da Nota
            document.getElementById('editSaleTotalValue').value = sale.totalValue.toFixed(2); 
            document.getElementById('editSalePaymentMethod').value = sale.paymentMethod;
            
            // Lógica para o novo campo de recalcular parcelas
            const newInstallmentsInput = document.getElementById('newInstallmentsInput');
            const recalculateBtn = document.getElementById('recalculateParcelsBtn');

            // Desabilita a função se a venda estiver quitada
            if (sale.status === 'quitado' || (sale.parcels || []).reduce((sum, p) => sum + p.value, 0) <= 0) {
                newInstallmentsInput.disabled = true;
                recalculateBtn.disabled = true;
                newInstallmentsInput.value = (sale.parcels || []).length;
            } else {
                newInstallmentsInput.disabled = false;
                recalculateBtn.disabled = false;
                newInstallmentsInput.value = (sale.parcels || []).length;
            }
            
            editSaleSelectedProducts = {};
            (sale.products || []).forEach(p => {
                editSaleSelectedProducts[p.productId] = { ...p };
            });

            renderEditSaleProducts();
            renderParcels(sale);
            renderAdvancements(sale);

            document.getElementById('paymentModal').classList.remove('hidden');
        }
        // =================================================================

        // Nova função para renderizar as parcelas
        function renderParcels(sale) {
            const parcelList = document.getElementById('parcelList');
            parcelList.innerHTML = '';
            
            const parcels = sale.parcels || [];
            parcels.forEach((parcel, index) => {
                const item = document.createElement('div');
                const dueDate = new Date(parcel.dueDate).toISOString().split('T')[0];
                
                let statusColor = '';
                let statusText = '';
                let buttonHtml = '';
                const today = new Date();
                const parcelDueDate = new Date(parcel.dueDate);

                // O status é 'Pago' se o status for 'pago' OU se o valor restante for zero (abatido por adiantamento)
                const isPaid = parcel.status === 'pago' || parcel.value <= 0;

                if (isPaid) {
                    statusColor = 'bg-green-500';
                    statusText = 'Pago';
                    // Reverter pagamento só é relevante se o pagamento foi manual (status === 'pago')
                    if(parcel.status === 'pago' && parcel.value > 0) {
                        buttonHtml = `<button onclick="revertParcelPayment('${sale.id}', ${index})" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 ml-4">Reverter</button>`;
                    }
                    
                } else if (parcelDueDate < today) {
                    statusColor = 'bg-orange-500';
                    statusText = 'Vencida';
                    buttonHtml = `<button onclick="markParcelAsPaid('${sale.id}', ${index})" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 ml-4">Marcar como Pago</button>`;
                } else {
                    statusColor = 'bg-blue-500';
                    statusText = 'Em Andamento';
                    buttonHtml = `<button onclick="markParcelAsPaid('${sale.id}', ${index})" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 ml-4">Marcar como Pago</button>`;
                }
                
                item.className = 'flex flex-wrap items-center justify-between p-3 border-b border-slate-700 last:border-b-0 gap-4 parcel-item-container';
                item.innerHTML = `
                    <div class="flex-1 min-w-[100px]">
                        <p class="text-sm font-medium text-white">Parcela ${parcel.parcelNumber}:</p>
                    </div>
                    <div class="flex-1 min-w-[120px]">
                         <label class="block text-xs font-medium text-slate-400">Valor (R$)</label>
                        <input type="number" step="0.01" value="${parcel.value.toFixed(2)}" class="parcel-value mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 text-sm border-2" ${isPaid ? 'readonly' : ''}>
                    </div>
                    <div class="flex-1 min-w-[120px]">
                        <label class="block text-xs font-medium text-slate-400">Vencimento</label>
                        <input type="date" value="${dueDate}" class="parcel-due-date mt-1 block w-full rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-2 text-sm border-2">
                    </div>
                    <div class="flex-1 min-w-[120px] flex items-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium text-white ${statusColor}">
                            ${statusText}
                        </span>
                        ${buttonHtml}
                    </div>
                `;
                parcelList.appendChild(item);
            });
        }
        
        // ======================= FUNÇÃO RECALCULAR PARCELAS =======================
        /**
         * NOVA FUNÇÃO: Recalcula as parcelas de uma venda existente.
         */
        window.recalculateParcels = () => {
            const sale = sales.find(s => s.id === currentSaleId);
            if (!sale) return;

            if (sale.status === 'quitado') {
                showToast("Não é possível recalcular parcelas de uma venda já quitada.", 'warning');
                return;
            }
            
            const newInstallmentsInput = document.getElementById('newInstallmentsInput');
            const newTotalInstallments = parseInt(newInstallmentsInput.value);
            
            if (isNaN(newTotalInstallments) || newTotalInstallments <= 0) {
                showToast("Por favor, insira um número de parcelas válido.", 'warning');
                return;
            }

            if (newTotalInstallments === (sale.parcels || []).length) {
                showToast("O novo número de parcelas é igual ao atual.", 'info');
                return;
            }

            // 1. Calcula o valor total que ainda falta pagar
            const totalRemainingValue = (sale.parcels || []).reduce((sum, p) => sum + p.value, 0);

            if (totalRemainingValue <= 0) {
                showToast("Esta venda já foi totalmente paga ou abatida. Não há valor para reparcelar.", 'warning');
                return;
            }
            
            // 2. Calcula o valor de cada nova parcela
            const newParcelValue = totalRemainingValue / newTotalInstallments;
            
            // 3. Gera o novo array de parcelas
            const newParcelsArray = [];
            const today = new Date();

            for (let i = 1; i <= newTotalInstallments; i++) {
                const dueDate = new Date();
                // A primeira parcela vence no próximo mês, e assim por diante
                dueDate.setMonth(today.getMonth() + i);
                
                newParcelsArray.push({
                    parcelNumber: i,
                    value: newParcelValue,
                    dueDate: dueDate.toISOString(),
                    status: 'em andamento'
                });
            }

            // 4. Atualiza o objeto da venda *localmente* e re-renderiza a lista de parcelas
            // As alterações só serão salvas no banco de dados ao clicar em "Salvar Alterações"
            const saleToUpdate = sales.find(s => s.id === currentSaleId);
            saleToUpdate.parcels = newParcelsArray;
            
            renderParcels(saleToUpdate);
            
            showToast("Parcelas recalculadas com sucesso! Revise os novos valores e datas, e clique em 'Salvar Alterações' para confirmar.", 'info');
        };
        // =================================================================

        // FUNÇÃO REESCRITA para aplicar adiantamento com a nova lógica
        window.applyAdvancePayment = async () => {
            const advanceInput = document.getElementById('advancePayment');
            let advanceValue = parseFloat(advanceInput.value);
            
            if (isNaN(advanceValue) || advanceValue <= 0) {
                showToast("Por favor, insira um valor de adiantamento válido.", 'warning');
                return;
            }

            const sale = sales.find(s => s.id === currentSaleId);
            if (!sale) return;

            // 1. Cria uma cópia profunda das parcelas para trabalhar localmente
            const updatedParcels = sale.parcels.map(p => ({ 
                ...p, 
                value: parseFloat(p.value.toFixed(2)) 
            })); 
            let remainingAdvance = advanceValue;
            let advancementApplied = false;

            // 2. Encontra todas as parcelas A PAGAR (value > 0 E status != 'pago')
            const availableParcels = updatedParcels
                .map((p, index) => ({ ...p, originalIndex: index }))
                .filter(p => p.value > 0 && p.status !== 'pago');

            if (availableParcels.length === 0) {
                showToast("Não há parcelas ativas para aplicar o adiantamento. Venda já quitada ou totalmente abatida.", 'warning');
                return;
            }
            
            // 3. ORDENA: Pela data de vencimento (mais próxima primeiro)
            availableParcels.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            
            const initialTargetIndex = availableParcels[0].originalIndex; // Índice da primeira parcela a ser abatida

            // 4. Abate o valor do adiantamento das parcelas em sequência ordenada
            for (let i = 0; i < availableParcels.length; i++) {
                if (remainingAdvance <= 0) break;

                const currentParcel = availableParcels[i];
                const originalIndex = currentParcel.originalIndex;
                const parcelValue = currentParcel.value;

                if (remainingAdvance >= parcelValue) {
                    // Adiantamento cobre toda a parcela
                    remainingAdvance -= parcelValue;
                    updatedParcels[originalIndex].value = 0;
                    updatedParcels[originalIndex].status = 'pago';
                    advancementApplied = true;
                } else {
                    // Adiantamento cobre parte da parcela
                    updatedParcels[originalIndex].value = parcelValue - remainingAdvance;
                    remainingAdvance = 0; // Adiantamento totalmente aplicado
                    advancementApplied = true;
                }
            }
            
            if(!advancementApplied) {
                showToast("Adiantamento não pôde ser aplicado.", 'warning');
                return;
            }
            
            // 5. Adiciona o adiantamento ao array de 'advancements'
            const newAdvancement = {
                value: advanceValue,
                date: new Date().toISOString().split('T')[0], // Data de hoje em YYYY-MM-DD
                parcelIndex: initialTargetIndex // Índice da primeira parcela abatida
            };
            
            const updatedAdvancements = [...(sale.advancements || []), newAdvancement];
            
            // 6. Calcula o novo valor total remanescente (soma dos valores remanescentes nas parcelas)
            const totalRemainingValue = updatedParcels.reduce((sum, p) => sum + p.value, 0);

            // 7. Atualiza o status da venda para 'quitado' se todas as parcelas forem a zero
            const allParcelsPaid = updatedParcels.every(p => p.value <= 0);
            const newSaleStatus = allParcelsPaid ? 'quitado' : 'em andamento';

            // 8. Persiste as alterações no Firestore
            const saleDocRef = doc(db, `artifacts/${appId}/users/${userId}/vendas`, currentSaleId);
            try {
                await updateDoc(saleDocRef, { 
                    parcels: updatedParcels,
                    advancements: updatedAdvancements,
                    status: newSaleStatus,
                    // totalValue NÂO é atualizado para manter o valor da nota
                });
                
                // 9. Renderiza as parcelas atualizadas na tela do modal
                const saleToRender = sales.find(s => s.id === currentSaleId);
                renderParcels(saleToRender);
                renderAdvancements(saleToRender); // ATUALIZADO: Renderiza a lista de adiantamentos também

                advanceInput.value = '0.00'; // Limpa o campo
                showToast("Adiantamento aplicado e salvo com sucesso! O valor das parcelas foi reduzido.");

            } catch (e) {
                 console.error("Erro ao aplicar adiantamento:", e);
                 showToast("Erro ao aplicar adiantamento.", 'warning');
            }
        };

        // NOVA FUNÇÃO: Reverte um adiantamento, devolvendo o valor para as parcelas
        window.revertAdvancement = async (saleId, advancementIndex) => {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;

            const advancements = sale.advancements || [];
            if (advancementIndex < 0 || advancementIndex >= advancements.length) {
                showToast("Adiantamento não encontrado.", 'warning');
                return;
            }

            // Confirmação do usuário
            // Usando showConfirmationModal para consistência com o restante do código
            window.showConfirmationModal('revert-advancement', { saleId, advancementIndex });
            
            // A lógica de reversão agora será tratada no listener de confirmação do modal principal
        };
        
        // Adiciona a lógica de `revert-advancement` ao modal principal
        document.getElementById('modal-confirm-btn').addEventListener('click', async () => {
            if (currentAction === 'revert-advancement') {
                const { saleId, advancementIndex } = currentItemId;
                const sale = sales.find(s => s.id === saleId);
                
                if (!sale) return;

                const advancements = sale.advancements || [];
                const advancementToRevert = advancements[advancementIndex];
                let valueToRestore = advancementToRevert.value;

                // 1. Remove o adiantamento da lista
                const updatedAdvancements = advancements.filter((_, index) => index !== advancementIndex);
                
                // 2. Cria uma cópia das parcelas para modificação
                const updatedParcels = JSON.parse(JSON.stringify(sale.parcels));
                
                // 3. Calcula o valor original de cada parcela
                const originalInstallmentValue = sale.totalValue / sale.installments;
                
                // 4. Restaura o valor nas parcelas, começando pela que foi abatida primeiro
                const startIndex = advancementToRevert.parcelIndex || 0;

                for (let i = startIndex; i < updatedParcels.length; i++) {
                    if (valueToRestore <= 0) break;

                    const parcel = updatedParcels[i];
                    
                    // O valor máximo que a parcela pode ter é o valor original da parcela na venda
                    const maxParcelValue = sale.parcels.length === updatedParcels.length ? originalInstallmentValue : parcel.value + valueToRestore; 

                    const spaceAvailable = maxParcelValue - parcel.value;
                    const amountToAdd = Math.min(valueToRestore, spaceAvailable);
                    
                    if (amountToAdd > 0) {
                        parcel.value += amountToAdd;
                        valueToRestore -= amountToAdd;
                        if(parcel.value > 0) {
                           parcel.status = 'em andamento';
                        }
                    }
                }
                
                // 5. Atualiza o status da venda para 'em andamento', pois ela não está mais quitada
                const allParcelsPaid = updatedParcels.every(p => p.status === 'pago' || p.value <= 0);
                const newSaleStatus = allParcelsPaid ? 'quitado' : 'em andamento';

                // 6. Salva as alterações no banco de dados
                try {
                    const saleDocRef = doc(db, `artifacts/${appId}/users/${userId}/vendas`, saleId);
                    await updateDoc(saleDocRef, {
                        advancements: updatedAdvancements,
                        parcels: updatedParcels,
                        status: newSaleStatus
                    });
                    
                    showToast("Adiantamento revertido com sucesso!");

                    // Atualiza a visualização do modal
                    const updatedSale = { ...sale, advancements: updatedAdvancements, parcels: updatedParcels, status: newSaleStatus };
                    renderParcels(updatedSale);
                    renderAdvancements(updatedSale);

                } catch (e) {
                    console.error("Erro ao reverter adiantamento:", e);
                    showToast("Erro ao reverter adiantamento.", 'warning');
                }
            } else if (currentAction === 'delete-sale' || currentAction === 'delete-client' || currentAction === 'delete-product' || currentAction === 'delete-event' || currentAction === 'cancel-sale') {
                // Mantém a lógica existente para outras ações
                // ... (seu código existente para estas ações)
                if (currentAction === 'delete-sale') {
                    await deleteSale(currentItemId);
                } else if (currentAction === 'delete-client') {
                    await deleteClientAndSales(currentItemId);
                } else if (currentAction === 'delete-product') {
                    await deleteProduct(currentItemId);
                } else if (currentAction === 'delete-event') {
                    await deleteEvent(currentItemId);
                } else if (currentAction === 'cancel-sale') {
                    try {
                        await revertStockFromSale(currentItemId);
                        const saleDocRef = doc(db, `artifacts/${appId}/users/${userId}/vendas`, currentItemId);
                        await updateDoc(saleDocRef, { status: 'cancelado' });
                        showToast("Status da venda atualizado para 'Cancelado'! O estoque foi revertido.");
                    } catch (e) {
                        console.error("Erro ao cancelar venda:", e);
                        showToast("Erro ao cancelar venda.", 'warning');
                    }
                }
            }
            document.getElementById('modal').classList.add('hidden');
        });

        // ======================= FUNÇÕES DE EDIÇÃO DE ID DE VENDA =======================

        /**
         * NOVO: Abre o modal de edição de ID.
         */
        window.openEditSaleIdModal = (saleId) => {
            currentEditingSaleId = saleId;
            document.getElementById('originalSaleId').value = saleId;
            document.getElementById('currentSaleIdDisplay').value = saleId;
            document.getElementById('newSaleIdInput').value = saleId;
            document.getElementById('editSaleIdModal').classList.remove('hidden');
        };

        /**
         * NOVO: Esconde o modal de edição de ID.
         */
        window.hideEditSaleIdModal = () => {
            document.getElementById('editSaleIdModal').classList.add('hidden');
            currentEditingSaleId = null;
        };

        // Adiciona listener de submissão ao formulário do modal
        document.getElementById('editSaleIdForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveSaleIdChange();
        });

        /**
         * NOVO: Salva a alteração do ID da venda no Firestore, movendo o documento.
         */
        async function saveSaleIdChange() {
            if (!isAuthReady || !currentEditingSaleId) {
                showToast('Aguarde a conexão ou selecione uma venda.', 'warning');
                return;
            }

            const newId = document.getElementById('newSaleIdInput').value.trim();
            const originalId = currentEditingSaleId;

            if (newId === originalId) {
                showToast("O novo ID é idêntico ao atual. Nenhuma alteração salva.", 'info');
                hideEditSaleIdModal();
                return;
            }

            // Simplificação da validação: IDs podem ser apenas números e letras.
            if (!newId || !/^[a-zA-Z0-9]+$/.test(newId)) {
                showToast("O novo ID deve conter apenas letras e números e não pode estar vazio.", 'warning');
                return;
            }
            
            // 1. Verifica se o novo ID já existe
            try {
                const newDocRef = doc(db, `artifacts/${appId}/users/${userId}/vendas`, newId);
                const newDocSnap = await getDoc(newDocRef);

                if (newDocSnap.exists()) {
                    showToast(`Erro: O ID de venda "${newId}" já está em uso. Escolha outro.`, 'warning');
                    return;
                }
            } catch (e) {
                console.error("Erro ao verificar novo ID:", e);
                showToast("Erro ao verificar novo ID.", 'warning');
                return;
            }

            // 2. Obtém os dados da venda original
            const saleToMove = sales.find(s => s.id === originalId);
            if (!saleToMove) {
                 showToast("Erro: Venda original não encontrada localmente.", 'warning');
                 return;
            }
            
            // Remove o ID do objeto de dados antes de salvá-lo como um novo doc (o ID já está no doc.ref)
            const saleData = { ...saleToMove };
            delete saleData.id; 

            // 3. Executa a transação (Batch Write)
            const batch = writeBatch(db);
            try {
                // Referência do documento original e do novo
                const originalDocRef = doc(db, `artifacts/${appId}/users/${userId}/vendas`, originalId);
                const newDocRef = doc(db, `artifacts/${appId}/users/${userId}/vendas`, newId);

                // a) Cria o novo documento com os dados da venda (setDoc)
                batch.set(newDocRef, saleData);

                // b) Deleta o documento original (deleteDoc)
                batch.delete(originalDocRef);

                // c) Commit da operação
                await batch.commit();
                
                // Sucesso
                showToast(`ID da venda alterado de "${originalId}" para "${newId}" com sucesso!`);
                hideEditSaleIdModal();

            } catch (e) {
                console.error("Erro ao mover/renomear o ID da venda:", e);
                showToast("Erro ao salvar o novo ID. Tente novamente.", 'warning');
            }
        }
        // =================================================================

        /**
         * FUNÇÃO CORRIGIDA E MELHORADA: saveAllChanges
         * - Agora usa o valor do input 'editSaleTotalValue' (que é editável) para validação e para salvar no DB.
         * - Isso garante que, ao adicionar novos produtos, o novo total seja persistido.
         */
        window.saveAllChanges = async () => {
            if (!currentSaleId) return;
            const sale = sales.find(s => s.id === currentSaleId);
            if (!sale) return;

            // Margem de erro permitida para problemas de ponto flutuante (R$ 0.01)
            const tolerance = 0.01;

            // 1. OBTÉM o Valor Total da Nota DO INPUT (valor editável e que será salvo)
            const valorTotalNotaInput = parseFloat(document.getElementById('editSaleTotalValue').value) || 0;
            
            // Se o valor for inválido, interrompe.
            if (isNaN(valorTotalNotaInput) || valorTotalNotaInput <= 0) {
                 showToast('O Valor Total da Venda (Nota R$) deve ser um número válido e maior que zero.', 'warning');
                return; 
            }

            // 2. Coleta as parcelas atualizadas do DOM e calcula o valor remanescente
            const updatedParcels = [];
            document.querySelectorAll('#parcelList > .parcel-item-container').forEach((item, index) => {
                const value = parseFloat(item.querySelector('.parcel-value').value);
                const dueDate = item.querySelector('.parcel-due-date').value;
                if(isNaN(value) || value < 0) {
                    showToast(`O valor da parcela ${index + 1} deve ser um número válido e maior ou igual a zero.`, 'warning');
                    return; 
                }

                const originalParcel = sale.parcels.find(p => p.parcelNumber === (index + 1));
                let newStatus = originalParcel.status;
                if (value === 0) {
                    newStatus = 'pago'; 
                } else if (originalParcel.status !== 'pago') {
                     newStatus = 'em andamento';
                }

                updatedParcels.push({
                    parcelNumber: index + 1,
                    value: value,
                    status: newStatus,
                    dueDate: dueDate
                });
            });
            
            // 3. Calcule o total pago (Adiantamentos)
            const totalAdiantamentos = (sale.advancements || []).reduce((sum, adv) => sum + adv.value, 0);

            // 4. Calcula a soma total atual (Parcelas Remanescentes + Adiantamentos)
            const totalParcelasRemanescentes = updatedParcels.reduce((sum, p) => sum + p.value, 0);
            const somaTotalAtual = totalParcelasRemanescentes + totalAdiantamentos;

            // 5. Realiza a validação: Nota Total (Input) deve ser igual à Soma (Parcelas + Adiantamentos)
            if (Math.abs(valorTotalNotaInput - somaTotalAtual) > tolerance) {
                const diferenca = (valorTotalNotaInput - somaTotalAtual).toFixed(2).replace('.', ',');
                
                showToast(`ERRO DE COERÊNCIA: O Valor Total da Venda (R$ ${valorTotalNotaInput.toFixed(2).replace('.', ',')}) deve ser igual à soma dos Adiantamentos e Parcelas Remanescentes (R$ ${somaTotalAtual.toFixed(2).replace('.', ',')}). Há uma diferença de R$ ${diferenca}. Por favor, corrija o Valor Total da Venda ou os valores das parcelas/adiantamentos.`, 'warning');
                return; // Interrompe o processo de salvamento
            }
            
            // ----------------------------------------------------------------------
            // SE A VALIDAÇÃO PASSAR, O PROCESSO DE SALVAMENTO SEGUE NORMALMENTE
            // ----------------------------------------------------------------------
            
            const batch = writeBatch(db);

            // 6. Lógica de estoque (ajuste baseado na diferença entre produtos antigos e novos)
            const originalProducts = sale.products || [];
            // Filtra os produtos válidos do modal de seleção (que podem ter sido editados)
            const updatedProducts = Object.values(editSaleSelectedProducts).filter(p => parseFloat(p.quantity) > 0 && parseFloat(p.value) > 0);
            
            const stockUpdates = {};
            originalProducts.forEach(originalProduct => {
                const updatedProduct = updatedProducts.find(up => up.productId === originalProduct.productId);
                if (!updatedProduct) {
                    // Produto removido: reverter estoque
                    stockUpdates[originalProduct.productId] = (stockUpdates[originalProduct.productId] || 0) + originalProduct.quantity;
                } else if (updatedProduct.quantity < originalProduct.quantity) {
                    // Quantidade diminuída: reverter diferença
                    stockUpdates[originalProduct.productId] = (stockUpdates[originalProduct.productId] || 0) + (originalProduct.quantity - updatedProduct.quantity);
                }
            });
            updatedProducts.forEach(updatedProduct => {
                const originalProduct = originalProducts.find(op => op.productId === updatedProduct.productId);
                if (!originalProduct) {
                    // Produto novo adicionado: diminuir estoque
                    stockUpdates[updatedProduct.productId] = (stockUpdates[updatedProduct.productId] || 0) - updatedProduct.quantity;
                } else if (updatedProduct.quantity > originalProduct.quantity) {
                    // Quantidade aumentada: diminuir diferença
                    stockUpdates[updatedProduct.productId] = (stockUpdates[updatedProduct.productId] || 0) - (updatedProduct.quantity - originalProduct.quantity);
                }
            });

            for (const productId in stockUpdates) {
                const stockChange = stockUpdates[productId];
                const product = products.find(p => p.id === productId);
                if (product) {
                    const newStock = (product.stock || 0) + stockChange;
                    if (newStock < 0) {
                        showToast(`Estoque insuficiente para a edição do produto: ${product.name}. A operação foi cancelada.`, 'warning');
                        return;
                    }
                    const productDocRef = doc(db, `artifacts/${appId}/users/${userId}/produtos`, productId);
                    batch.update(productDocRef, { stock: newStock });
                }
            }

            // 7. Salva as alterações na venda
            const newEventId = document.getElementById('editSaleEventSelect').value;
            const newEvent = events.find(e => e.id === newEventId);
            const newEventName = newEvent ? newEvent.name : 'Evento não encontrado';
            const newPaymentMethod = document.getElementById('editSalePaymentMethod').value;
            
            const allParcelsPaid = updatedParcels.every(p => p.status === 'pago' || p.value === 0);
            const newSaleStatus = allParcelsPaid ? 'quitado' : 'em andamento';
            
            const saleDocRef = doc(db, `artifacts/${appId}/users/${userId}/vendas`, currentSaleId);
            
            batch.update(saleDocRef, {
                eventId: newEventId,
                eventName: newEventName,
                paymentMethod: newPaymentMethod,
                parcels: updatedParcels,
                products: updatedProducts,
                advancements: sale.advancements || [], // Garante que adiantamentos são mantidos
                status: newSaleStatus,
                totalValue: valorTotalNotaInput, // <--- CORRIGIDO: Salva o novo valor da nota
                lastUpdated: new Date().toISOString()
            });


            // 8. Commit as alterações
            try {
                await batch.commit();
                showToast("Venda atualizada e estoque ajustado com sucesso!");
                window.hidePaymentModal();
            } catch (e) {
                console.error("Erro ao salvar as alterações:", e);
                showToast("Erro ao salvar as alterações.", 'warning');
            }
        };
        
        window.saveAndSendEmail = async () => {
            // saveAllChanges é assíncrono e não retorna um valor booleano, 
            // então não podemos confiar que foi bem sucedido antes de enviar o email.
            // Para simplificar, faremos o envio de email após o save.
            await saveAllChanges();
            enviarEmail(currentSaleId);
        };
        
        window.saveAndVisualizarPdf = async () => {
            // saveAllChanges é assíncrono.
            await saveAllChanges();
            visualizarPdf(currentSaleId);
        };

        window.hidePaymentModal = () => {
            document.getElementById('paymentModal').classList.add('hidden');
        }
        
        // Função para verificar e atualizar o status da venda para 'quitado'
        async function checkIfSaleIsPaid(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;

            const allPaidOrZero = (sale.parcels || []).every(p => p.status === 'pago' || p.value <= 0);
            if (allPaidOrZero && sale.status !== 'quitado') {
                try {
                    const saleDocRef = doc(db, `artifacts/${appId}/users/${userId}/vendas`, saleId);
                    await updateDoc(saleDocRef, { status: 'quitado' });
                    showToast("Venda quitada com sucesso!");
                } catch (e) {
                    console.error("Erro ao atualizar status para 'quitado':", e);
                    showToast("Erro ao atualizar status da venda.", 'warning');
                }
            }
        }

        /**
         * FUNÇÃO ATUALIZADA:
         * Agora, antes de marcar como pago, ela salva as alterações de valor e data de todas as parcelas.
         */
        window.markParcelAsPaid = async (saleId, parcelIndex) => {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;

            // 1. Coleta os valores e datas atuais dos inputs do modal e prepara a atualização da parcela clicada
            const updatedParcels = [];
            let totalValueOriginalSale = 0; // Para calcular o valor total ORIGINAL da venda (sem adiantamentos)

            document.querySelectorAll('#parcelList > .parcel-item-container').forEach((item, index) => {
                const value = parseFloat(item.querySelector('.parcel-value').value);
                const dueDate = item.querySelector('.parcel-due-date').value;
                const originalParcel = sale.parcels.find(p => p.parcelNumber === (index + 1));
                
                let status = originalParcel.status;
                if (index === parcelIndex) {
                    status = 'pago'; // Marca a parcela clicada como paga manualmente
                } else if (value <= 0) {
                    status = 'pago'; // Mantém como pago se o valor for zero (pelo adiantamento)
                }
                
                // NOTA: Para o markParcelAsPaid, mantemos o valor do input (que pode ter sido abatido ou editado)
                const finalValue = (index === parcelIndex) ? 0 : value; // Se foi pago manualmente, o valor passa a ser 0

                updatedParcels.push({
                    parcelNumber: index + 1,
                    value: finalValue,
                    status: status,
                    dueDate: dueDate
                });
            });

            // 2. Recalcula o valor total remanescente (a pagar)
            const totalRemainingValue = updatedParcels.reduce((sum, p) => sum + p.value, 0);

            try {
                const saleDocRef = doc(db, `artifacts/${appId}/users/${userId}/vendas`, saleId);
                await updateDoc(saleDocRef, { 
                    parcels: updatedParcels,
                    // REMOVIDO: totalValue: totalRemainingValue, // Não atualiza mais o totalValue
                    status: (totalRemainingValue <= 0) ? 'quitado' : 'em andamento'
                });
                showToast("Parcela marcada como paga e dados salvos!");
                // Não precisamos mais de checkIfSaleIsPaid, pois já verificamos acima.
                
            } catch (e) {
                console.error("Erro ao marcar parcela como paga:", e);
                showToast("Erro ao marcar parcela como paga.", 'warning');
            }
        };
        
        /**
         * FUNÇÃO ATUALIZADA:
         * Reverte o pagamento manual de uma parcela, voltando ao status 'em andamento'.
         */
        window.revertParcelPayment = async (saleId, parcelIndex) => {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;

            // 1. Encontra o valor original da parcela (se existir uma cópia antes do adiantamento, seria melhor)
            // Como não temos o valor original da parcela antes de um adiantamento, usaremos o valor atual do input, mas voltando o status
            
            // Coleta os valores e datas atuais dos inputs do modal
            const updatedParcels = [];
            
            // Valor antes do pagamento manual (para o caso de ter sido abatido)
            let valueBeforeManualPayment = 0; 

            document.querySelectorAll('#parcelList > .parcel-item-container').forEach((item, index) => {
                const value = parseFloat(item.querySelector('.parcel-value').value);
                const dueDate = item.querySelector('.parcel-due-date').value;
                const originalParcel = sale.parcels.find(p => p.parcelNumber === (index + 1));
                
                let status = originalParcel.status;
                let finalValue = value;

                if (index === parcelIndex) {
                    status = 'em andamento'; // Reverte o status
                    // Se a parcela estava marcada como 'pago' *manualmente* (value > 0), voltamos o status.
                    // Se o status era 'pago' *por adiantamento* (value <= 0), não revertemos o valor.
                    if (originalParcel.status === 'pago' && originalParcel.value > 0) {
                        // Se foi paga manualmente (status 'pago' e valor > 0 antes de zerar), restauramos o valor original da parcela na criação
                        // NOTA: Para restaurar o valor, precisaríamos do valor original da parcela, que não está armazenado separadamente. 
                        // Já que as parcelas podem ter sido alteradas/adiantadas, o único valor de referência é o que estava no Firestore antes da mudança.
                        // Para evitar a perda total do valor, vamos forçar o status para 'em andamento' e manter o valor que estava no input.
                        // *No entanto*, o `markParcelAsPaid` seta o valor para 0. Aqui vamos restaurar o valor que estava no Firestore.
                        
                        // Encontra o valor que a parcela tinha no Firestore ANTES do pagamento
                        const saleBeforePayment = sales.find(s => s.id === saleId);
                        const parcelBeforePayment = saleBeforePayment.parcels[parcelIndex];
                        finalValue = parcelBeforePayment.value;
                        
                    } else if (originalParcel.value <= 0) {
                         // Se a parcela foi zerada por adiantamento, *não* alteramos o valor, apenas o status (caso o adiantamento tenha sido revertido).
                         // Mas como não temos lógica de reversão de adiantamento, apenas revertemos o status se não for 0.
                         finalValue = originalParcel.value; // Mantém 0
                         status = 'pago'; // Reverter um "pago" que é 0 deve ser impossível sem reverter o adiantamento.
                         showToast("A reversão de pagamento não se aplica a parcelas abatidas por adiantamento.", 'warning');
                         return; // Aborta a operação
                    } else {
                        // Caso padrão de reversão de um pagamento manual (status pago)
                        finalValue = originalParcel.value;
                    }
                    valueBeforeManualPayment = originalParcel.value;

                } else if (value <= 0) {
                    status = 'pago'; // Mantém como pago se o valor for zero
                    finalValue = value;
                } else {
                    status = originalParcel.status;
                    finalValue = value;
                }

                updatedParcels.push({
                    parcelNumber: index + 1,
                    value: finalValue,
                    status: status,
                    dueDate: dueDate
                });
            });

            // Recalcula o valor total remanescente
            const totalRemainingValue = updatedParcels.reduce((sum, p) => sum + p.value, 0);

            try {
                const saleDocRef = doc(db, `artifacts/${appId}/users/${userId}/vendas`, saleId);
                await updateDoc(saleDocRef, { 
                    parcels: updatedParcels, 
                    status: 'em andamento', // O status da venda volta para "em andamento"
                    // REMOVIDO: totalValue: totalRemainingValue // Não atualiza mais o totalValue
                });
                showToast("Pagamento da parcela revertido e dados salvos!");
            } catch (e) {
                console.error("Erro ao reverter o pagamento da parcela:", e);
                showToast("Erro ao reverter o pagamento da parcela.", 'warning');
            }
        };

        // --- Funções de Edição de Cliente ---
        window.openEditClientModal = (clientId) => {
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                showToast("Cliente não encontrado.", 'warning');
                return;
            }
            
            currentEditingClientId = clientId;
            document.getElementById('editClientName').value = client.name;
            document.getElementById('editClientCpf').value = client.cpf;
            document.getElementById('editClientPhone').value = client.phone || '';
            document.getElementById('editClientEmail').value = client.email || '';
            document.getElementById('editClientEmergencyContactName').value = client.emergencyContactName || '';
            document.getElementById('editClientEmergencyContact').value = client.emergencyContact || '';
            document.getElementById('editClientBirthDate').value = client.birthDate || '';
            
            document.getElementById('editClientModal').classList.remove('hidden');
        };

        window.hideEditClientModal = () => {
            document.getElementById('editClientModal').classList.add('hidden');
            currentEditingClientId = null;
        };

        document.getElementById('editClientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const clientData = {
                name: document.getElementById('editClientName').value,
                cpf: document.getElementById('editClientCpf').value,
                phone: document.getElementById('editClientPhone').value,
                email: document.getElementById('editClientEmail').value,
                emergencyContactName: document.getElementById('editClientEmergencyContactName').value,
                emergencyContact: document.getElementById('editClientEmergencyContact').value,
                birthDate: document.getElementById('editClientBirthDate').value
            };
            await updateClient(currentEditingClientId, clientData);
        });
        
        window.addStockQuickly = async (productId, quantity) => {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            try {
                const newStock = (product.stock || 0) + quantity;
                const productDocRef = doc(db, `artifacts/${appId}/users/${userId}/produtos`, productId);
                await updateDoc(productDocRef, { stock: newStock });
                showToast(`${quantity} unidade(s) adicionada(s) ao estoque de ${product.name}!`);
            } catch (e) {
                console.error("Erro ao adicionar estoque:", e);
                showToast("Erro ao adicionar estoque.", 'warning');
            }
        }

        function renderEditSaleProducts() {
            const list = document.getElementById('editSaleProductsList');
            list.innerHTML = '';
            if (Object.keys(editSaleSelectedProducts).length === 0) {
                list.innerHTML = '<li class="text-slate-400">Nenhum produto adicionado.</li>';
                return;
            }
            
            // Adiciona o cabeçalho
            const header = document.createElement('li');
            header.className = 'bg-slate-700 rounded-lg p-2 flex justify-between items-center font-semibold text-xs text-white uppercase';
            header.innerHTML = `
                <span>Nome do Produto</span>
                <div class="flex space-x-2 items-center">
                    <span class="w-16 text-center">Qtd</span>
                    <span class="w-20 text-center">Lote</span>
                    <span class="w-20 text-center">Valor (R$)</span>
                </div>
            `;
            list.appendChild(header);

            Object.keys(editSaleSelectedProducts).forEach(productId => {
                const product = products.find(p => p.id === productId);
                const listItem = document.createElement('li');
                listItem.className = 'bg-slate-800 rounded-lg p-2 flex flex-col sm:flex-row justify-between items-start sm:items-center';
                
                const productInfo = product ? `<span class="text-white">${product.name}</span>` : `<span class="text-red-500">Produto removido (ID: ${productId})</span>`;

                listItem.innerHTML = `
                    ${productInfo}
                    <div class="flex items-center mt-2 sm:mt-0">
                        <label class="text-sm text-slate-400 mr-2">Qtd:</label>
                        <input type="number" data-product-id="${productId}" data-type="quantity" value="${editSaleSelectedProducts[productId].quantity}" min="1" max="10" class="edit-sale-product-quantity w-16 text-right rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-1 text-sm border-2 mr-4">
                        <label class="text-sm text-slate-400 mr-2">Lote:</label>
                        <input type="number" data-product-id="${productId}" data-type="lot" value="${editSaleSelectedProducts[productId].lot || ''}" min="1" max="10" class="edit-sale-product-lot w-24 text-right rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-1 text-sm border-2 mr-4">
                        <label class="text-sm text-slate-400 mr-2">Valor:</label>
                        <input type="number" step="0.01" data-product-id="${productId}" data-type="value" value="${editSaleSelectedProducts[productId].value}" min="0.01" class="edit-sale-product-value w-24 text-right rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-1 text-sm border-2">
                        <button type="button" onclick="removeProductFromEditSale('${productId}')" class="text-red-500 hover:text-red-700 font-bold ml-2">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                list.appendChild(listItem);
            });

            document.querySelectorAll('#editSaleProductsList input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const productId = e.target.dataset.productId;
                    const type = e.target.dataset.type;
                    let value = e.target.value;

                    if (type === 'quantity' || type === 'lot') {
                        value = parseInt(value);
                        if (isNaN(value) || value < 1) value = 1;
                        if (value > 10) value = 10;
                        e.target.value = value;
                    } else if (type === 'value') {
                        value = parseFloat(value);
                        if (isNaN(value) || value < 0.01) value = 0.01;
                        e.target.value = value.toFixed(2);
                    }

                    editSaleSelectedProducts[productId][type] = value;
                    updateSaleTotal('edit-sale');
                });
            });
        }

        window.removeProductFromEditSale = (productId) => {
            delete editSaleSelectedProducts[productId];
            renderEditSaleProducts();
            updateSaleTotal('edit-sale');
        };
        
        window.openEditProductModal = (productId) => {
            const product = products.find(p => p.id === productId);
            if (!product) {
                showToast("Produto não encontrado.", 'warning');
                return;
            }
            
            currentEditingProductId = productId;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductCost').value = product.cost.toFixed(2);
            document.getElementById('editProductStock').value = product.stock;
            
            document.getElementById('editProductModal').classList.remove('hidden');
        };

        window.hideEditProductModal = () => {
            document.getElementById('editProductModal').classList.add('hidden');
            currentEditingProductId = null;
        };


        // --- Funções de Seleção de Produtos ---
        window.openProductSelectionModal = (mode) => {
            isEditingProductsInPaymentModal = (mode === 'edit-sale');
            
            const container = document.getElementById('productSelectionCheckboxes');
            container.innerHTML = '';

            const productSearchInput = document.getElementById('productSearchInput');
            productSearchInput.value = ''; // Limpa o campo de pesquisa ao abrir o modal
            
            // Adiciona o cabeçalho
            const header = document.createElement('div');
            header.className = 'flex justify-between items-center py-2 border-b-2 font-semibold text-white';
            header.innerHTML = `
                <span>Produto</span>
                <div class="flex space-x-2 items-center">
                    <span class="w-16 text-center">Qtd</span>
                    <span class="w-20 text-center">Lote</span>
                    <span class="w-20 text-center">Valor (R$)</span>
                </div>
            `;
            container.appendChild(header);

            const renderProductsToSelect = (filteredProducts) => {
                container.innerHTML = '';
                container.appendChild(header);
                
                filteredProducts.forEach(product => {
                    const currentProducts = isEditingProductsInPaymentModal ? editSaleSelectedProducts : newSaleSelectedProducts;
                    const productData = currentProducts[product.id] || { quantity: 0, lot: null, value: 0 };
                    
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center py-2 border-b last:border-b-0';
                    div.innerHTML = `
                        <span class="text-slate-300">Código ${product.code} - ${product.name}</span>
                        <div class="flex space-x-2">
                            <input type="number" data-product-id="${product.id}" data-type="quantity" value="${productData.quantity}" min="1" max="10" class="product-selection-input w-16 text-center rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-1 text-sm border-2">
                            <input type="number" data-product-id="${product.id}" data-type="lot" value="${productData.lot || ''}" min="1" max="10" class="product-selection-input w-20 text-center rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-1 text-sm border-2">
                            <input type="number" step="0.01" data-product-id="${product.id}" data-type="value" value="${productData.value}" min="0.01" class="product-selection-input w-20 text-center rounded-md border-slate-700 bg-slate-900 text-white shadow-sm p-1 text-sm border-2">
                        </div>
                    `;
                    container.appendChild(div);
                });

                 // Re-adiciona os event listeners aos inputs renderizados
                document.querySelectorAll('#productSelectionCheckboxes input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const productId = e.target.dataset.productId;
                        const type = e.target.dataset.type;
                        let value = e.target.value;

                        if (type === 'quantity' || type === 'lot') {
                            value = parseInt(value);
                            if (isNaN(value) || value < 1) value = 1;
                            if (value > 10) value = 10;
                            e.target.value = value;
                        } else if (type === 'value') {
                            value = parseFloat(value);
                            if (isNaN(value) || value < 0.01) value = 0.01;
                            e.target.value = value.toFixed(2);
                        }

                        const currentProducts = isEditingProductsInPaymentModal ? editSaleSelectedProducts : newSaleSelectedProducts;
                        if (!currentProducts[productId]) {
                             currentProducts[productId] = { productId, quantity: 0, lot: null, value: 0 };
                        }
                        currentProducts[productId][type] = value;
                    });
                });
            };

            // Adiciona o event listener de pesquisa
            productSearchInput.addEventListener('keyup', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredProducts = products.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) || 
                    p.code.toString().includes(searchTerm)
                );
                renderProductsToSelect(filteredProducts);
            });
            
            // Renderiza todos os produtos inicialmente
            renderProductsToSelect(products);

            document.getElementById('productSelectionModal').classList.remove('hidden');
        };

        window.hideProductSelectionModal = () => {
            document.getElementById('productSelectionModal').classList.add('hidden');
        };

        window.saveSelectedProducts = () => {
            const tempProducts = {};
            document.querySelectorAll('#productSelectionCheckboxes .product-selection-input').forEach(input => {
                const productId = input.dataset.productId;
                const type = input.dataset.type;
                let value = input.value;
                const product = products.find(p => p.id === productId);

                if (!tempProducts[productId]) {
                    tempProducts[productId] = { productId, quantity: 0, lot: null, value: 0 };
                }
                
                // Trata a conversão de tipo apenas para campos numéricos
                if (type === 'quantity' || type === 'lot') {
                    const parsedValue = parseInt(value);
                    tempProducts[productId][type] = isNaN(parsedValue) ? 0 : parsedValue;
                } else if (type === 'value') {
                    const parsedValue = parseFloat(value);
                    tempProducts[productId][type] = isNaN(parsedValue) ? 0 : parsedValue;
                }
            });

            const validatedProducts = {};
            for (const productId in tempProducts) {
                const p = tempProducts[productId];
                if (p.quantity >= 1 && p.quantity <= 10 && p.value > 0) {
                    validatedProducts[productId] = {
                        productId: p.productId,
                        quantity: p.quantity,
                        lot: p.lot || null,
                        value: p.value
                    };
                }
            }
            
            if (isEditingProductsInPaymentModal) {
                editSaleSelectedProducts = validatedProducts;
                renderEditSaleProducts();
                updateSaleTotal('edit-sale');
            } else {
                newSaleSelectedProducts = validatedProducts;
                renderNewSaleProducts();
                updateSaleTotal('new-sale');
            }
            
            showToast(`Produtos para a venda salvos temporariamente.`);
            hideProductSelectionModal();
        };

        // --- Funções de formatação de data para evitar problemas de fuso horário ---
        function formatDateAsDDMMYYYY(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            const day = String(date.getUTCDate()).padStart(2, '0');
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const year = date.getUTCFullYear();
            return `${day}/${month}/${year}`;
        }
        
        /**
         * NOVA FUNÇÃO: Gera a lista mesclada e ordenada de parcelas e adiantamentos.
         * É usada tanto para o e-mail quanto para o PDF.
         */
        function getParcelAndAdvancementDetails(sale) {
            const items = [];
            
            // 1. Adiciona todas as parcelas
            (sale.parcels || []).forEach(p => {
                const isAbated = p.value <= 0;
                const statusDisplay = isAbated ? 'Pago (Abatido)' : p.status.charAt(0).toUpperCase() + p.status.slice(1);

                items.push({
                    type: 'parcel',
                    sortDate: p.dueDate,
                    display: `- Parcela ${p.parcelNumber}: R$ ${p.value.toFixed(2).replace('.', ',')} (Vencimento: ${formatDateAsDDMMYYYY(p.dueDate)}) - Status: ${statusDisplay}`
                });
            });

            // 2. Adiciona todos os adiantamentos e os vincula à parcela original
            (sale.advancements || []).forEach(adv => {
                const parcelAbatida = (sale.parcels || []).find(p => p.parcelNumber === (adv.parcelIndex + 1));
                
                items.push({
                    type: 'advancement',
                    sortDate: adv.date, 
                    display: `[ADTO] Data: ${formatDateAsDDMMYYYY(adv.date)} | Status: Adiantamento Pago | Valor: R$ ${adv.value.toFixed(2).replace('.', ',')} -> Abatido a partir da Parcela ${parcelAbatida ? parcelAbatida.parcelNumber : 'N/A'}`
                });
            });

            // 3. Ordena por data (o adiantamento deve vir antes da parcela que compartilha a mesma data de vencimento/aplicação)
            items.sort((a, b) => new Date(a.sortDate) - new Date(b.sortDate));

            return items.map(item => item.display).join('\n');
        }

        // --- FUNÇÃO ATUALIZADA PARA USAR MAILTO: ---
        function enviarEmail(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) {
                showToast("Venda não encontrada.", 'warning');
                return;
            }
            
            const client = clients.find(c => c.id === sale.clientId);
            if (!client || !client.email) {
                showToast("E-mail do cliente não encontrado.", 'warning');
                return;
            }
            
            // Usa o totalValue salvo no DB (o valor da nota)
            const originalTotalValue = sale.totalValue ? sale.totalValue.toFixed(2).replace('.', ',') : '0,00';
            
            // Calcula o valor remanescente a pagar (soma dos valores restantes nas parcelas)
            const totalRemainingValue = sale.parcels.reduce((sum, p) => sum + (p.value || 0), 0).toFixed(2).replace('.', ',');
            
            const productsList = (sale.products || []).map(item => {
                const product = products.find(p => p.id === item.productId);
                const productName = product ? product.name : 'Produto Removido';
                const lot = item.lot ? ` (Lote: ${item.lot})` : '';
                return `- ${productName} (Qtd: ${item.quantity})${lot}`;
            }).join('\n');
            
            // Usa a nova função para gerar os detalhes de parcelas e adiantamentos
            const parcelDetails = getParcelAndAdvancementDetails(sale);
            
            const to = client.email;
            const subject = `Comprovante de Pedido #${sale.id} - VendavalStore`;
            
            // O texto editável agora é texto simples, sem HTML
            const body = `
Olá, ${client.name}!

Aqui estão os detalhes do seu pedido Nº ID #${sale.id}: na Vendaval Store.

Valor Total da Venda (Nota): R$ ${originalTotalValue}
Forma de Pagamento: ${sale.paymentMethod}
Evento: ${sale.eventName}

Produtos:
${productsList}

Parcelas e Adiantamentos:
${parcelDetails}

---
${editableText}
            `;

            const url = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            window.location.href = url;
            showToast("Abrindo o seu cliente de e-mail com os dados preenchidos.");
        }
        
        // --- FIM DA FUNÇÃO ATUALIZADA ---

        // Função para visualizar um PDF no navegador
        window.visualizarPdf = (saleId) => {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;
            const client = clients.find(c => c.id === sale.clientId);
            
            const totalRemainingValue = sale.parcels.reduce((sum, p) => sum + (p.value || 0), 0);
            // Usa o totalValue salvo no DB (o valor da nota)
            const originalTotal = sale.totalValue || 0;


            const productsText = (sale.products || []).map(item => {
                const product = products.find(p => p.id === item.productId);
                const productName = product ? product.name : 'Produto Removido';
                const lotText = item.lot ? `Lote: ${item.lot}` : 'N/A';
                const totalItemValue = (item.quantity * item.value).toFixed(2).replace('.', ',');
                return `<div class="parcel-item">- ${productName} (Qtd: ${item.quantity}, ${lotText}, Valor: R$ ${item.value.toFixed(2).replace('.', ',')}) - Total: R$ ${totalItemValue}</div>`;
            }).join('');
            
            // Usa a nova função para gerar os detalhes de parcelas e adiantamentos
            const parcelAndAdvancementText = getParcelAndAdvancementDetails(sale);
            // Converte o texto simples com quebras de linha para HTML com <br>
            const formattedParcelAndAdvancementText = parcelAndAdvancementText.replace(/\n/g, '<br>');

            // Converte o texto simples do rodapé com quebras de linha para HTML com <br>
            const formattedEditableText = editableText.replace(/\n/g, '<br>');


            const content = `
                <style>
                    body { font-family: 'Inter', sans-serif; margin: 2rem; background-color: #f3f4f6; color: #1e293b; }
                    .header { text-align: center; margin-bottom: 2rem; }
                    .header h1 { font-size: 2rem; font-weight: bold; }
                    .info { margin-bottom: 1rem; }
                    .info span { font-weight: bold; }
                    .parcels-list { margin-top: 1rem; }
                    .parcel-item { margin-bottom: 0.5rem; }
                    .footer { text-align: center; margin-top: 3rem; }
                    .important-text { font-weight: bold; }
                    .editable-text-container { margin-top: 20px; }
                </style>
                <div class="header">
                    <h1>Comprovante de Pedido - VendavalStore</h1>
                </div>
                <div class="info">
                    <p><span>Pedido ID:</span> ${sale.id}</p>
                    <p><span>Data:</span> ${formatDateAsDDMMYYYY(sale.createdAt)}</p>
                    <p><span>Cliente:</span> ${client ? client.name : 'Removido'}</p>
                    <p><span>CPF:</span> ${client ? client.cpf : 'N/A'}</p>
                    <p><span>Email:</span> ${client ? client.email : 'N/A'}</p>
                </div>
                <div class="info">
                    <p><span>Evento:</span> ${sale.eventName}</p>
                    <p><span>Valor Total da Venda (Nota):</span> R$ ${originalTotal.toFixed(2).replace('.', ',')}</p>
                    <p><span>Forma de Pagamento:</span> ${sale.paymentMethod}</p>
                </div>
                <div class="parcels-list">
                    <p><span>Produtos:</span></p>
                    ${productsText}
                </div>
                <div class="parcels-list">
                    <p><span>Parcelas e Adiantamentos:</span></p>
                    <div style="white-space: pre-wrap;">${formattedParcelAndAdvancementText}</div>
                </div>
                <div class="editable-text-container">
                    ${formattedEditableText}
                </div>
            `;
            const pdfWindow = window.open('', '_blank');
            pdfWindow.document.write(content);
            pdfWindow.document.close();
            pdfWindow.print();
            showToast("Visualizando comprovante de PDF...");
        };

        // --- Funções de Backup e Restauro ---
        window.showBackupModal = () => {
            document.getElementById('backupModal').classList.remove('hidden');
        };

        window.hideBackupModal = () => {
            document.getElementById('backupModal').classList.add('hidden');
        };

        window.downloadBackup = async () => {
            if (!isAuthReady) {
                showToast('Aguarde a conexão com o banco de dados...', 'warning');
                return;
            }
            try {
                const clientsSnapshot = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/clientes`));
                const productsSnapshot = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/produtos`));
                const salesSnapshot = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/vendas`));
				const backupData = {
                    clients: clientsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                    products: productsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                    sales: salesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                };

                const backupJson = JSON.stringify(backupData, null, 2);
                const blob = new Blob([backupJson], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `vendavalstore_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast("Backup baixado com sucesso!");
                hideBackupModal();
            } catch (e) {
                console.error("Erro ao baixar backup:", e);
                showToast("Erro ao baixar backup.", 'warning');
            }
        };

        document.getElementById('restore-file').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                const text = event.target.result;
                try {
                    const backupData = JSON.parse(text);
                    if (backupData.clients && backupData.products && backupData.sales) {
                        if (window.confirm("Atenção: A restauração irá apagar todos os seus dados atuais e substituí-los pelo backup. Deseja continuar?")) {
                             await restoreBackup(backupData);
                        } else {
                            showToast("Restauração cancelada.", 'info');
                        }
                    } else {
                        showToast("Ficheiro de backup inválido. Verifique o formato.", 'warning');
                    }
                } catch (e) {
                    console.error("Erro ao carregar ficheiro de backup:", e);
                    showToast("Erro ao carregar ficheiro. Verifique se é um ficheiro JSON válido.", 'warning');
                }
            };
            reader.readAsText(file);
        });

        async function restoreBackup(backupData) {
            if (!isAuthReady) {
                showToast('Aguarde a conexão com o banco de dados...', 'warning');
                return;
            }
            try {
                showToast("A restaurar dados... Por favor, não feche a página.");
                
                const batch = writeBatch(db);

                const clearCollection = async (collectionName) => {
                    const colRef = collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`);
                    const snapshot = await getDocs(colRef);
                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                };
                
                await clearCollection('clientes');
                await clearCollection('produtos');
                await clearCollection('vendas');

                backupData.clients.forEach(client => {
                    const docRef = doc(db, `artifacts/${appId}/users/${userId}/clientes`, client.id);
                    batch.set(docRef, client);
                });
                backupData.products.forEach(product => {
                    const docRef = doc(db, `artifacts/${appId}/users/${userId}/produtos`, product.id);
                    batch.set(docRef, product);
                });
                backupData.sales.forEach(sale => {
                    // Garante que o campo advancements exista
                    if (!sale.advancements) {
                        sale.advancements = [];
                    }
                    const docRef = doc(db, `artifacts/${appId}/users/${userId}/vendas`, sale.id);
                    batch.set(docRef, sale);
                });

                await batch.commishowToast("Dados restaurados com sucesso! A aplicação será atualizada.");
                hideBackupModal();
            } catch (e) {
                console.error("Erro ao restaurar dados:", e);
                showToast("Erro ao restaurar dados.", 'warning');
            }
        }

        window.downloadDetailedReport = async (format) => {
            if (!isAuthReady) {
                showToast('Aguarde a conexão com o banco de dados...', 'warning');
                return;
            }

            showToast("A gerar o relatório... Por favor, aguarde.");

            const clientsData = clients;
            const productsData = products;
            const salesData = sales;
            
            const paidSales = sales.filter(sale => sale.status === 'quitado');
            
            // CORREÇÃO APLICADA AQUI: Adiciona a verificação p.status !== 'pago' para maior coerência
            const inProgressSales = sales.filter(sale => sale.status === 'em andamento' && sale.parcels && !sale.parcels.some(p => p.status !== 'pago' && new Date(p.dueDate) < new Date() && p.value > 0));
            const overdueSales = sales.filter(sale => sale.status === 'em andamento' && sale.parcels && sale.parcels.some(p => p.status !== 'pago' && new Date(p.dueDate) < new Date() && p.value > 0));

            const canceledSales = sales.filter(sale => sale.status === 'cancelado');
            const pendingPaymentCount = inProgressSales.length + overdueSales.length;

            const detailedReport = {
                metadata: {
                    dataGeracao: new Date().toLocaleString('pt-BR'),
                    totalClientes: clientsData.length,
                    totalProdutos: productsData.length,
                    totalVendas: salesData.length,
                    // Total de faturamento deve ser o total original (não o remanescente)
                    faturamentoTotalOriginal: salesData.reduce((sum, s) => sum + (s.totalValue || 0), 0), 
                    vendasPagas: paidSales.length,
                    vendasEmAndamento: inProgressSales.length,
                    vendasVencidas: overdueSales.length,
                    vendasFaltandoPagar: pendingPaymentCount,
                    vendasCanceladas: canceledSales.length
                },
                clientes: clientsData,
                produtos: productsData,
                vendas: salesData.map(sale => {
                    const client = clientsData.find(c => c.id === sale.clientId);
                    const clientName = client ? client.name : 'Cliente Removido';
                    
                    // Encontra o valor total ORIGINAL da venda (sem abatimentos)
                    const originalTotal = (sale.products || []).reduce((sum, p) => sum + (p.quantity * p.value), 0);
                    // Calcula o total já recebido (original - remanescente)
                    const totalRemanescente = sale.parcels.reduce((sum, p) => sum + (p.value || 0), 0);
                    const totalRecebido = originalTotal - totalRemanescente;

                    const detailedProducts = (sale.products || []).map(item => {
                        const selectedProduct = productsData.find(p => p.id === item.productId);
                        return {
                            produto: selectedProduct ? selectedProduct.name : 'Produto Removido',
                            codigo: selectedProduct ? selectedProduct.code : 'N/A',
                            quantidade: item.quantity,
                            lote: item.lot || 'N/A',
                            valorUnitario: item.value,
                            valorTotalItem: item.quantity * item.value
                        };
                    });
                    
                    return {
                        id: sale.id,
                        cliente: clientName,
                        evento: sale.eventName,
                        valorTotalOriginal: originalTotal,
                        valorTotalRecebido: totalRecebido,
                        valorTotalRemanescente: totalRemanescente,
                        dataVenda: new Date(sale.createdAt).toLocaleString('pt-BR'),
                        produtosDetalhado: detailedProducts,
                        parcelas: sale.parcels,
                        adiantamentos: sale.advancements || []
                    };
                })
            };

            if (format === 'json') {
                const reportJson = JSON.stringify(detailedReport, null, 2);
                const blob = new Blob([reportJson], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `relatorio_vendavalstore_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast("Relatório JSON baixado com sucesso!");
            } else if (format === 'pdf') {
                // A função visualizarRelatorioPdf faz isso
            }
        };

        // NOVA FUNÇÃO: Relatório de Pedidos Vencidos
        window.visualizarRelatorioPedidosVencidos = async () => {
            if (!isAuthReady) {
                showToast('Aguarde a conexão com o banco de dados...', 'warning');
                return;
            }

            showToast("A gerar o relatório de pedidos vencidos... Por favor, aguarde.");

            const today = new Date();
            
            // Filtra vendas que têm pelo menos uma parcela vencida
            const overdueSales = sales.filter(sale => 
                sale.status === 'em andamento' && 
                sale.parcels && 
                sale.parcels.some(p => p.status !== 'pago' && new Date(p.dueDate) < today && p.value > 0)
            );

            if (overdueSales.length === 0) {
                showToast("Não há pedidos vencidos no momento!", 'info');
                return;
            }

            // Prepara os dados do relatório
            const reportData = overdueSales.map(sale => {
                const client = clients.find(c => c.id === sale.clientId);
                const clientName = client ? client.name : 'Cliente Removido';
                const clientPhone = client ? client.phone : 'N/A';
                const clientEmail = client ? client.email : 'N/A';

                const originalTotal = (sale.products || []).reduce((sum, p) => sum + (p.quantity * p.value), 0);
                const totalRemanescente = sale.parcels.reduce((sum, p) => sum + (p.value || 0), 0);
                
                // Filtra apenas as parcelas vencidas
                const overdueParcels = sale.parcels.filter(p => 
                    p.status !== 'pago' && new Date(p.dueDate) < today && p.value > 0
                );

                const totalOverdue = overdueParcels.reduce((sum, p) => sum + p.value, 0);

                return {
                    id: sale.id,
                    cliente: clientName,
                    telefone: clientPhone,
                    email: clientEmail,
                    evento: sale.eventName,
                    valorTotalOriginal: originalTotal,
                    valorTotalRemanescente: totalRemanescente,
                    valorVencido: totalOverdue,
                    dataVenda: new Date(sale.createdAt).toLocaleString('pt-BR'),
                    parcelasVencidas: overdueParcels,
                    produtos: (sale.products || []).map(item => {
                        const product = products.find(p => p.id === item.productId);
                        return {
                            nome: product ? product.name : 'Produto Removido',
                            codigo: product ? product.code : 'N/A',
                            quantidade: item.quantity,
                            lote: item.lot || 'N/A',
                            valor: item.value
                        };
                    })
                };
            });

            // Calcula totais gerais
            const totalVencidoGeral = reportData.reduce((sum, s) => sum + s.valorVencido, 0);
            const totalParcelasVencidas = reportData.reduce((sum, s) => sum + s.parcelasVencidas.length, 0);

            // Gera o HTML do relatório
            const pdfContent = `
                <style>
                    body { font-family: 'Inter', sans-serif; margin: 2rem; background-color: #fff3cd; color: #1e293b; }
                    h1, h2, h3 { color: #d97706; }
                    .header { margin-bottom: 2rem; text-align: center; background-color: #fff; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                    .header h1 { font-size: 2rem; font-weight: bold; color: #c2410c; margin-bottom: 0.5rem; }
                    .alert-box { background-color: #fed7aa; border-left: 4px solid #f97316; padding: 1rem; margin-bottom: 2rem; border-radius: 0.5rem; }
                    .summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem; }
                    .summary-card { background-color: #fff; border: 2px solid #fdba74; border-radius: 0.5rem; padding: 1rem; text-align: center; }
                    .summary-card strong { font-size: 1.5rem; color: #ea580c; display: block; margin-top: 0.5rem; }
                    .section { background-color: #fff; padding: 1.5rem; margin-bottom: 1.5rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                    .section-title { font-size: 1.25rem; font-weight: bold; color: #c2410c; border-bottom: 2px solid #fed7aa; padding-bottom: 0.5rem; margin-bottom: 1rem; }
                    .sale-card { border: 2px solid #fdba74; padding: 1rem; margin-bottom: 1rem; border-radius: 0.5rem; background-color: #fffbeb; }
                    .sale-header { font-size: 1.1rem; font-weight: bold; color: #c2410c; margin-bottom: 0.75rem; }
                    .info-row { margin: 0.5rem 0; }
                    .info-label { font-weight: 600; color: #78350f; }
                    .overdue-parcel { background-color: #fee2e2; border-left: 3px solid #dc2626; padding: 0.5rem; margin: 0.5rem 0; border-radius: 0.25rem; }
                    .overdue-amount { color: #dc2626; font-weight: bold; font-size: 1.1rem; }
                    table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
                    th, td { text-align: left; padding: 0.5rem; border-bottom: 1px solid #fed7aa; }
                    th { background-color: #fef3c7; font-size: 0.875rem; color: #78350f; font-weight: 600; }
                </style>
                <div class="header">
                    <h1>⚠️ RELATÓRIO DE PEDIDOS VENCIDOS</h1>
                    <p style="color: #78350f; font-weight: 500;">VendavalStore - Gerado em: ${new Date().toLocaleString('pt-BR')}</p>
                </div>
                
                <div class="alert-box">
                    <strong style="color: #c2410c;">ATENÇÃO:</strong> Este relatório contém todos os pedidos com parcelas vencidas que ainda não foram pagas.
                </div>

                <div class="summary">
                    <div class="summary-card">
                        <div style="color: #78350f; font-size: 0.875rem;">Total de Pedidos Vencidos</div>
                        <strong>${reportData.length}</strong>
                    </div>
                    <div class="summary-card">
                        <div style="color: #78350f; font-size: 0.875rem;">Total de Parcelas Vencidas</div>
                        <strong>${totalParcelasVencidas}</strong>
                    </div>
                    <div class="summary-card">
                        <div style="color: #78350f; font-size: 0.875rem;">Valor Total Vencido</div>
                        <strong>R$ ${totalVencidoGeral.toFixed(2).replace('.', ',')}</strong>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">Detalhamento dos Pedidos Vencidos</h2>
                    ${reportData.map(sale => `
                        <div class="sale-card">
                            <div class="sale-header">📋 Pedido #${sale.id} - ${sale.cliente}</div>
                            
                            <div class="info-row">
                                <span class="info-label">📞 Telefone:</span> ${sale.telefone}
                            </div>
                            <div class="info-row">
                                <span class="info-label">✉️ Email:</span> ${sale.email}
                            </div>
                            <div class="info-row">
                                <span class="info-label">🎪 Evento:</span> ${sale.evento}
                            </div>
                            <div class="info-row">
                                <span class="info-label">📅 Data da Venda:</span> ${sale.dataVenda}
                            </div>
                            <div class="info-row">
                                <span class="info-label">💰 Valor Total Original:</span> R$ ${sale.valorTotalOriginal.toFixed(2).replace('.', ',')}
                            </div>
                            <div class="info-row">
                                <span class="info-label">💸 Valor Total Restante:</span> R$ ${sale.valorTotalRemanescente.toFixed(2).replace('.', ',')}
                            </div>
                            <div class="info-row">
                                <span class="info-label overdue-amount">⚠️ Valor Vencido:</span> <span class="overdue-amount">R$ ${sale.valorVencido.toFixed(2).replace('.', ',')}</span>
                            </div>

                            <div style="margin-top: 1rem;">
                                <strong style="color: #78350f;">📦 Produtos:</strong>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Código</th>
                                            <th>Produto</th>
                                            <th>Qtd</th>
                                            <th>Lote</th>
                                            <th>Valor Unit.</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${sale.produtos.map(p => `
                                            <tr>
                                                <td>${p.codigo}</td>
                                                <td>${p.nome}</td>
                                                <td>${p.quantidade}</td>
                                                <td>${p.lote}</td>
                                                <td>R$ ${p.valor.toFixed(2).replace('.', ',')}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>

                            <div style="margin-top: 1rem;">
                                <strong style="color: #dc2626;">⏰ Parcelas Vencidas:</strong>
                                ${sale.parcelasVencidas.map(p => {
                                    const diasVencidos = Math.floor((today - new Date(p.dueDate)) / (1000 * 60 * 60 * 24));
                                    return `
                                        <div class="overdue-parcel">
                                            <strong>Parcela ${p.parcelNumber}</strong><br>
                                            Valor: <strong>R$ ${p.value.toFixed(2).replace('.', ',')}</strong><br>
                                            Vencimento: ${new Date(p.dueDate).toLocaleDateString('pt-BR')}<br>
                                            <span style="color: #dc2626; font-weight: 600;">Vencida há ${diasVencidos} dia(s)</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="section" style="background-color: #fed7aa; border: 2px solid #f97316;">
                    <h3 style="margin: 0; color: #c2410c;">💡 RESUMO FINAL</h3>
                    <p style="margin: 0.5rem 0 0 0; font-size: 1.1rem; color: #78350f;">
                        <strong>${reportData.length}</strong> pedido(s) com <strong>${totalParcelasVencidas}</strong> parcela(s) vencida(s),
                        totalizando <strong style="color: #dc2626; font-size: 1.25rem;">R$ ${totalVencidoGeral.toFixed(2).replace('.', ',')}</strong> em atraso.
                    </p>
                </div>
            `;

            const pdfWindow = window.open('', '_blank');
            pdfWindow.document.write(pdfContent);
            pdfWindow.document.close();
            showToast("Relatório de pedidos vencidos gerado com sucesso!");
        };

        window.visualizarRelatorioPdf = async () => {
             if (!isAuthReady) {
                showToast('Aguarde a conexão com o banco de dados...', 'warning');
                return;
            }

            showToast("A gerar o relatório... Por favor, aguarde.");

            const clientsData = clients;
            const productsData = products;
            const salesData = sales;
            
            const paidSales = sales.filter(sale => sale.status === 'quitado');

            // CORREÇÃO APLICADA AQUI: Adiciona a verificação p.status !== 'pago' para maior coerência
            const inProgressSales = sales.filter(sale => sale.status === 'em andamento' && sale.parcels && !sale.parcels.some(p => p.status !== 'pago' && new Date(p.dueDate) < new Date() && p.value > 0));
            const overdueSales = sales.filter(sale => sale.status === 'em andamento' && sale.parcels && sale.parcels.some(p => p.status !== 'pago' && new Date(p.dueDate) < new Date() && p.value > 0));
            
            const canceledSales = sales.filter(sale => sale.status === 'cancelado');
            const pendingPaymentCount = inProgressSales.length + overdueSales.length;
            
            // Recalcular faturamento total original (apenas para o resumo)
            const faturamentoTotalOriginal = salesData.reduce((sum, s) => sum + (s.products || []).reduce((sumP, p) => sumP + (p.quantity * p.value), 0), 0);

            const detailedReport = {
                metadata: {
                    dataGeracao: new Date().toLocaleString('pt-BR'),
                    totalClientes: clientsData.length,
                    totalProdutos: productsData.length,
                    totalVendas: salesData.length,
                    faturamentoTotalOriginal: faturamentoTotalOriginal,
                    vendasPagas: paidSales.length,
                    vendasEmAndamento: inProgressSales.length,
                    vendasVencidas: overdueSales.length,
                    vendasFaltandoPagar: pendingPaymentCount,
                    vendasCanceladas: canceledSales.length
                },
                clientes: clientsData,
                produtos: productsData,
                vendas: salesData.map(sale => {
                    const client = clientsData.find(c => c.id === sale.clientId);
                    const clientName = client ? client.name : 'Cliente Removido';

                    const originalTotal = (sale.products || []).reduce((sum, p) => sum + (p.quantity * p.value), 0);
                    const totalRemanescente = sale.parcels.reduce((sum, p) => sum + (p.value || 0), 0);
                    const totalRecebido = originalTotal - totalRemanescente;

                    const detailedProducts = (sale.products || []).map(item => {
                        const selectedProduct = productsData.find(p => p.id === item.productId);
                        return {
                            produto: selectedProduct ? selectedProduct.name : 'Produto Removido',
                            codigo: selectedProduct ? selectedProduct.code : 'N/A',
                            quantidade: item.quantity,
                            lote: item.lot || 'N/A',
                            valorUnitario: item.value,
                            valorTotalItem: item.quantity * item.value
                        };
                    });
                    
                    return {
                        id: sale.id,
                        cliente: clientName,
                        evento: sale.eventName,
                        valorTotalOriginal: originalTotal,
                        valorTotalRecebido: totalRecebido,
                        valorTotalRemanescente: totalRemanescente,
                        dataVenda: new Date(sale.createdAt).toLocaleString('pt-BR'),
                        produtosDetalhado: detailedProducts,
parcelas: sale.parcels,
                        adiantamentos: sale.advancements || []
                    };
                })
            };

            const pdfContent = `
                <style>
                    body { font-family: 'Inter', sans-serif; margin: 2rem; background-color: #f3f4f6; color: #1e293b; }
                    h1, h2, h3 { color: #1f2937; }
                    .header, .section { margin-bottom: 2rem; }
                    .header h1 { font-size: 2rem; font-weight: bold; text-align: center; }
                    .section-title { font-size: 1.5rem; font-weight: bold; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; margin-bottom: 1rem; }
                    .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
                    .stat-card { border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; }
                    .table-container { margin-top: 1rem; }
                    table { width: 100%; border-collapse: collapse; }
                    th, td { text-align: left; padding: 0.75rem; border-bottom: 1px solid #e5e7eb; }
                    th { background-color: #f3f4f6; font-size: 0.75rem; color: #4b5563; text-transform: uppercase; }
                    .client-info p, .product-info p, .sale-info p { margin: 0.25rem 0; }
                    .payment-detail { margin-top: 0.5rem; border-top: 1px dashed #ccc; padding-top: 0.5rem; font-size: 0.9em; }
                    .advancement { color: #16a34a; font-weight: bold; }
                </style>
                <div class="header">
                    <h1>Relatório Detalhado - VendavalStore</h1>
                    <p>Gerado em: ${detailedReport.metadata.dataGeracao}</p>
                </div>
                <div class="section">
                    <h2 class="section-title">Resumo Financeiro</h2>
                    <div class="stat-grid">
                        <div class="stat-card"><strong>Faturamento Total Original:</strong> R$ ${detailedReport.metadata.faturamentoTotalOriginal.toFixed(2).replace('.', ',')}</div>
                        <div class="stat-card"><strong>Vendas Pagas:</strong> ${detailedReport.metadata.vendasPagas}</div>
                        <div class="stat-card"><strong>Vendas em Andamento:</strong> ${detailedReport.metadata.vendasEmAndamento}</div>
                        <div class="stat-card"><strong>Vendas Vencidas:</strong> ${detailedReport.metadata.vendasVencidas}</div>
                        <div class="stat-card"><strong>Vendas Faltando a Pagar:</strong> ${detailedReport.metadata.vendasFaltandoPagar}</div>
                        <div class="stat-card"><strong>Vendas Canceladas:</strong> ${detailedReport.metadata.vendasCanceladas}</div>
                        <div class="stat-card"><strong>Total de Clientes:</strong> ${detailedReport.metadata.totalClientes}</div>
                        <div class="stat-card"><strong>Total de Produtos:</strong> ${detailedReport.metadata.totalProdutos}</div>
                    </div>
                </div>
                <div class="section">
                    <h2 class="section-title">Detalhamento de Clientes</h2>
                    ${detailedReport.clientes.map(cliente => `
                        <div class="client-info" style="border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; border-radius: 0.5rem;">
                            <h3>Cliente: ${cliente.name}</h3>
                            <p><strong>CPF:</strong> ${cliente.cpf}</p>
                            <p><strong>Contato:</strong> ${cliente.phone} / ${cliente.email}</p>
                        </div>
                    `).join('')}
                </div>
                <div class="section">
                    <h2 class="section-title">Detalhamento de Produtos</h2>
                    ${detailedReport.produtos.map(produto => `
                        <div class="product-info" style="border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; border-radius: 0.5rem;">
                            <h3>Produto: ${produto.name}</h3>
                            <p><strong>Código:</strong> ${produto.code}</p>
                            <p><strong>Custo:</strong> R$ ${produto.cost.toFixed(2).replace('.', ',')}</p>
                            <p><strong>Estoque:</strong> ${produto.stock}</p>
                        </div>
                    `).join('')}
                </div>
                <div class="section">
                    <h2 class="section-title">Detalhamento de Vendas</h2>
                    ${detailedReport.vendas.map(sale => {
                        // Mescla e ordena parcelas e adiantamentos para o PDF
                        const items = [];
                        (sale.parcelas || []).forEach(p => {
                            const isAbated = p.value <= 0;
                            const statusDisplay = isAbated ? 'Pago (Abatido)' : p.status.charAt(0).toUpperCase() + p.status.slice(1);
                            items.push({
                                type: 'parcel',
                                sortDate: p.dueDate,
                                display: `<li>Parcela ${p.parcelNumber}: R$ ${p.value.toFixed(2).replace('.', ',')} (Vencimento: ${new Date(p.dueDate).toLocaleDateString('pt-BR')}) - Status: <strong>${statusDisplay}</strong></li>`
                            });
                        });
                        (sale.adiantamentos || []).forEach(adv => {
                            const parcelAbatida = (sale.parcelas || []).find(p => p.parcelNumber === (adv.parcelIndex + 1));
                            items.push({
                                type: 'advancement',
                                sortDate: adv.date, 
                                display: `<li class="advancement">[ADTO] Data: ${new Date(adv.date).toLocaleDateString('pt-BR')} | Status: Adiantamento Pago | Valor: R$ ${adv.value.toFixed(2).replace('.', ',')} -> Abatido a partir da Parcela ${parcelAbatida ? parcelAbatida.parcelNumber : 'N/A'}</li>`
                            });
                        });

                        items.sort((a, b) => new Date(a.sortDate) - new Date(b.sortDate));
                        const parcelAdvancementList = items.map(item => item.display).join('');

                        return `
                            <div class="sale-info" style="border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; border-radius: 0.5rem;">
                                <h3>Venda ID: ${sale.id}</h3>
                                <p><strong>Cliente:</strong> ${sale.cliente}</p>
                                <p><strong>Data:</strong> ${sale.dataVenda}</p>
                                <p><strong>Evento:</strong> ${sale.evento}</p>
                                <p><strong>Valor Total Original:</strong> R$ ${sale.valorTotalOriginal.toFixed(2).replace('.', ',')}</p>
                                <p><strong>Valor Remanescente:</strong> R$ ${sale.valorTotalRemanescente.toFixed(2).replace('.', ',')}</p>
                                <p><strong>Produtos:</strong></p>
                                <ul>
                                    ${sale.produtosDetalhado.map(p => `<li>${p.quantidade}x ${p.produto} - Lote: ${p.lote} - R$ ${p.valorUnitario.toFixed(2).replace('.', ',')}</li>`).join('')}
                                </ul>
                                <p class="payment-detail"><strong>Pagamentos e Parcelas:</strong></p>
                                <ul>
                                    ${parcelAdvancementList}
                                </ul>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            const pdfWindow = window.open('', '_blank');
            pdfWindow.document.write(pdfContent);
            pdfWindow.document.close();
            showToast("Visualizando relatório de PDF...");
        };

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            toast.className = `fixed bottom-4 right-4 text-white px-4 py-2 rounded-lg shadow-lg transition-opacity duration-300 ${type === 'warning' ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        /**
         * NOVA FUNÇÃO: Calcula a quantidade total vendida de cada produto.
         * @returns {Array<Object>} Lista de produtos com total vendido e nome, ordenada por quantidade.
         */
        function getProductsSoldSummary() {
            const soldSummary = {};
            let totalOverall = 0;

            sales.forEach(sale => {
                if (sale.products) {
                    sale.products.forEach(item => {
                        const productId = item.productId;
                        const quantity = item.quantity || 0;
                        
                        // Garante que só conta produtos de vendas não canceladas ou quitadas
                        if (sale.status !== 'cancelado') {
                            if (soldSummary[productId]) {
                                soldSummary[productId].totalSold += quantity;
                            } else {
                                const productInfo = products.find(p => p.id === productId);
                                soldSummary[productId] = {
                                    name: productInfo ? productInfo.name : 'Produto Removido',
                                    code: productInfo ? productInfo.code : 'N/A',
                                    totalSold: quantity
                                };
                            }
                            totalOverall += quantity;
                        }
                    });
                }
            });

            const summaryArray = Object.values(soldSummary);
            // Ordena por quantidade total vendida (decrescente)
            summaryArray.sort((a, b) => b.totalSold - a.totalSold);
            
            return { summary: summaryArray, totalOverall };
        }

        /**
         * NOVA FUNÇÃO: Gera um relatório PDF dos produtos vendidos.
         */
        window.visualizarRelatorioProdutosVendidos = () => {
            const { summary, totalOverall } = getProductsSoldSummary();

            if (summary.length === 0) {
                showToast("Não há produtos vendidos para gerar o relatório.", 'warning');
                return;
            }

            const productsTableRows = summary.map(item => `
                <tr style="border-bottom: 1px solid #e5e7eb;">
                    <td style="padding: 0.75rem;">${item.code}</td>
                    <td style="padding: 0.75rem;">${item.name}</td>
                    <td style="padding: 0.75rem; text-align: right;">${item.totalSold}</td>
                </tr>
            `).join('');

            const content = `
                <style>
                    body { font-family: 'Inter', sans-serif; margin: 2rem; color: #1e293b; }
                    .header { text-align: center; margin-bottom: 2rem; }
                    .header h1 { font-size: 2rem; font-weight: bold; color: #1f2937; }
                    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
                    th, td { text-align: left; padding: 0.75rem; border-bottom: 1px solid #e5e7eb; }
                    th { background-color: #f3f4f6; font-size: 0.75rem; color: #4b5563; text-transform: uppercase; }
                    .total-row { background-color: #e2e8f0; font-weight: bold; }
                    .total-row td { border-top: 2px solid #1e293b; }
                </style>
                <div class="header">
                    <h1>Relatório de Produtos Vendidos (Todas as Vendas)</h1>
                    <p>Período: Todas as Vendas | Gerado em: ${new Date().toLocaleString('pt-BR')}</p>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th style="width: 15%;">Código</th>
                            <th style="width: 65%;">Nome do Produto</th>
                            <th style="width: 20%; text-align: right;">Total Vendido</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${productsTableRows}
                        <tr class="total-row">
                            <td colspan="2" style="padding: 0.75rem; text-align: left;">TOTAL GERAL DE ITENS VENDIDOS</td>
                            <td style="padding: 0.75rem; text-align: right;">${totalOverall}</td>
                        </tr>
                    </tbody>
                </table>
            `;

            const pdfWindow = window.open('', '_blank');
            pdfWindow.document.write(content);
            pdfWindow.document.close();
            pdfWindow.print();
            showToast("Visualizando relatório de produtos vendidos em PDF...");
        };
        
        // --- NOVO: Funções para o Relatório por Evento ---
        
        window.showReportByEventModal = () => {
             // Garante que o select está preenchido
            populateReportEventSelect();
            document.getElementById('reportByEventModal').classList.remove('hidden');
        };

        window.hideReportByEventModal = () => {
            document.getElementById('reportByEventModal').classList.add('hidden');
        };

        window.generateEventReport = () => {
            const eventId = document.getElementById('reportEventSelect').value;
            if (!eventId) {
                showToast("Por favor, selecione um evento.", 'warning');
                return;
            }
            visualizarRelatorioPorEvento(eventId);
            hideReportByEventModal();
        };

        /**
         * NOVA FUNÇÃO: Gera o relatório em PDF dos produtos vendidos em um evento específico.
         * @param {string} eventId ID do evento selecionado.
         */
        window.visualizarRelatorioPorEvento = (eventId) => {
            const event = events.find(e => e.id === eventId);
            const eventName = event ? event.name : 'Evento Não Encontrado';

            // 1. Filtra as vendas pelo evento, ignorando canceladas
            const salesInEvent = sales.filter(s => s.eventId === eventId && s.status !== 'cancelado');
            
            if (salesInEvent.length === 0) {
                showToast(`Nenhuma venda encontrada para o evento "${eventName}".`, 'warning');
                return;
            }

            // 2. Agrupa e soma os produtos vendidos
            const soldSummary = {};
            let totalOverall = 0;
            let totalRevenue = 0;
            let totalPaid = 0;
            let totalPending = 0;

            salesInEvent.forEach(sale => {
                if (sale.products) {
                    sale.products.forEach(item => {
                        const productId = item.productId;
                        const quantity = item.quantity || 0;
                        const value = item.value || 0;
                        
                        const productInfo = products.find(p => p.id === productId);
                        const productName = productInfo ? productInfo.name : 'Produto Removido';
                        const productCode = productInfo ? productInfo.code : 'N/A';
                        
                        if (soldSummary[productId]) {
                            soldSummary[productId].totalSold += quantity;
                        } else {
                            soldSummary[productId] = {
                                name: productName,
                                code: productCode,
                                value: value, // Mantém o valor unitário da primeira ocorrência para exibição
                                totalSold: quantity
                            };
                        }
                        totalOverall += quantity;
                        totalRevenue += quantity * value;
                    });
                }

                // Calcula total pago e total a pagar baseado nas parcelas
                if (sale.parcels && Array.isArray(sale.parcels)) {
                    sale.parcels.forEach(parcel => {
                        const parcelValue = parcel.value || 0;
                        if (parcel.status === 'pago') {
                            totalPaid += parcelValue;
                        } else {
                            totalPending += parcelValue;
                        }
                    });
                }
            });

            const summaryArray = Object.values(soldSummary);
            // Ordena por quantidade total vendida (decrescente)
            summaryArray.sort((a, b) => b.totalSold - a.totalSold);
            
            // 3. Monta o HTML do relatório em PDF
            const productsTableRows = summaryArray.map(item => `
                <tr style="border-bottom: 1px solid #e5e7eb;">
                    <td style="padding: 0.75rem;">${item.code}</td>
                    <td style="padding: 0.75rem;">${item.name}</td>
                    <td style="padding: 0.75rem; text-align: right;">R$ ${item.value.toFixed(2).replace('.', ',')}</td>
                    <td style="padding: 0.75rem; text-align: right;">${item.totalSold}</td>
                    <td style="padding: 0.75rem; text-align: right;">R$ ${(item.value * item.totalSold).toFixed(2).replace('.', ',')}</td>
                </tr>
            `).join('');

            const content = `
                <style>
                    body { font-family: 'Inter', sans-serif; margin: 2rem; color: #1e293b; }
                    .header { text-align: center; margin-bottom: 2rem; }
                    .header h1 { font-size: 2rem; font-weight: bold; color: #1f2937; }
                    .header h2 { font-size: 1.5rem; color: #4b5563; margin-top: 0.5rem; }
                    table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
                    th, td { text-align: left; padding: 0.75rem; border-bottom: 1px solid #e5e7eb; }
                    th { background-color: #e2e8f0; font-size: 0.75rem; color: #1e293b; text-transform: uppercase; }
                    .total-row { background-color: #d1d5db; font-weight: bold; }
                    .total-row td { border-top: 2px solid #1e293b; }
                    .summary-box { border: 2px solid #3b82f6; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; background-color: #eff6ff; }
                    .summary-box p { font-size: 1.1rem; }
                </style>
                <div class="header">
                    <h1>Relatório de Vendas por Evento</h1>
                    <h2>Evento: ${eventName}</h2>
                    <p>Gerado em: ${new Date().toLocaleString('pt-BR')}</p>
                </div>

                <div class="summary-box">
                    <p><strong>Total de Vendas no Evento:</strong> ${salesInEvent.length}</p>
                    <p><strong>Total Geral de Produtos Vendidos:</strong> ${totalOverall}</p>
                    <p><strong>Faturamento Total (Valor de Venda):</strong> R$ ${totalRevenue.toFixed(2).replace('.', ',')}</p>
                    <p style="color: #10B981;"><strong>Total Pago:</strong> R$ ${totalPaid.toFixed(2).replace('.', ',')}</p>
                    <p style="color: #F59E0B;"><strong>Total a Pagar:</strong> R$ ${totalPending.toFixed(2).replace('.', ',')}</p>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th style="width: 10%;">Código</th>
                            <th style="width: 40%;">Nome do Produto</th>
                            <th style="width: 15%; text-align: right;">Valor Unitário (R$)</th>
                            <th style="width: 15%; text-align: right;">Quantidade Total</th>
                            <th style="width: 20%; text-align: right;">Valor Total (R$)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${productsTableRows}
                        <tr class="total-row">
                            <td colspan="4" style="padding: 0.75rem; text-align: left;">TOTAL GERAL DE PRODUTOS VENDIDOS</td>
                            <td style="padding: 0.75rem; text-align: right;">R$ ${totalRevenue.toFixed(2).replace('.', ',')}</td>
                        </tr>
                    </tbody>
                </table>
            `;

            const pdfWindow = window.open('', '_blank');
            pdfWindow.document.write(content);
            pdfWindow.document.close();
            pdfWindow.print();
            showToast(`Visualizando relatório do evento "${eventName}" em PDF...`);
        };


        window.showSection = showSection;
        window.deleteClientAndSales = deleteClientAndSales;
        window.showConfirmationModal = showConfirmationModal;
        window.deleteProduct = deleteProduct;
        window.deleteEvent = deleteEvent;
        window.openPaymentModal = openPaymentModal;
        window.hidePaymentModal = hidePaymentModal;
        window.markParcelAsPaid = markParcelAsPaid;
        window.revertParcelPayment = revertParcelPayment;
        window.enviarEmail = enviarEmail;
        window.visualizarPdf = visualizarPdf;
        window.visualizarRelatorioPdf = visualizarRelatorioPdf;
        window.visualizarRelatorioPedidosVencidos = visualizarRelatorioPedidosVencidos;
        window.visualizarRelatorioProdutosVendidos = visualizarRelatorioProdutosVendidos; // Exporta a função
        window.openEditClientModal = openEditClientModal;
        window.hideEditClientModal = hideEditClientModal;
        window.saveAllChanges = saveAllChanges;
        window.saveAndSendEmail = saveAndSendEmail;
        window.saveAndVisualizarPdf = saveAndVisualizarPdf;
        window.openProductSelectionModal = openProductSelectionModal;
        window.hideProductSelectionModal = hideProductSelectionModal;
        window.saveSelectedProducts = saveSelectedProducts;
        window.showBackupModal = showBackupModal;
        window.hideBackupModal = hideBackupModal;
        window.downloadBackup = downloadBackup;
        window.restoreBackup = restoreBackup;
        window.downloadDetailedReport = downloadDetailedReport;
        window.logout = logout;
        window.updateClient = updateClient;
        window.openEditProductModal = openEditProductModal;
        window.hideEditProductModal = hideEditProductModal;
        window.openTextEditModal = openTextEditModal;
        window.hideTextEditModal = hideTextEditModal;
        window.saveEditableText = saveEditableText;
        window.applyAdvancePayment = applyAdvancePayment; // Exporta a nova função de adiantamento
        window.showReportByEventModal = showReportByEventModal; // NOVO: Exporta a função do modal
        window.hideReportByEventModal = hideReportByEventModal; // NOVO: Exporta a função para esconder o modal
        window.generateEventReport = generateEventReport; // NOVO: Exporta a função para gerar o relatório
        window.visualizarRelatorioPorEvento = visualizarRelatorioPorEvento; // NOVO: Exporta a função de relatório
    </script>
</body>
</html>
